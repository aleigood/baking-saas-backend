<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>配方编辑器</title> <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <style>
            :root {
                --primary-color: #8c5a3b;
                --accent-color: #d4a373;
                --bg-color: #fdf8f2;
                --card-bg: #ffffff;
                --text-primary: #4a3f35;
                --text-secondary: #a98467;
                --danger-color: #e74c3c;
                --border-color: #f3e9e3;
                --sidebar-bg: #f7f4ef;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans',
                    sans-serif;
                background-color: var(--bg-color);
                color: var(--text-primary);
                margin: 0;
                font-size: 16px;
            }

            #app {
                display: flex;
                height: 100vh;
                overflow: hidden;
                max-width: 1024px;
                margin: 0 auto;
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            }

            /* --- Modal --- */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .modal-content {
                background-color: white;
                border-radius: 20px;
                padding: 25px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
            }
            .modal-header {
                font-size: 18px;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 20px;
                text-align: center;
            }
            .modal-body {
                overflow-y: auto;
                flex-grow: 1;
            }
            .modal-body .selection-item {
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 8px;
                cursor: pointer;
                transition: background-color 0.2s;
                text-align: center;
                font-weight: 500;
                border: 1px solid var(--border-color);
            }
            .modal-body .selection-item:hover {
                background-color: var(--sidebar-bg);
                border-color: var(--accent-color);
            }

            .modal-footer {
                margin-top: 20px;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }

            /* --- 左侧栏 --- */
            .sidebar {
                width: 300px;
                flex-shrink: 0;
                background-color: var(--sidebar-bg);
                display: flex;
                flex-direction: column;
                border-right: 1px solid var(--border-color);
            }

            .sidebar-header {
                padding: 20px;
                text-align: center;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar-header h1 {
                font-size: 24px;
                color: var(--primary-color);
                margin: 0;
            }

            .sidebar-header p {
                font-size: 13px;
                color: var(--text-secondary);
                margin-top: 5px;
            }

            .sidebar-tabs {
                display: flex;
                padding: 10px;
                gap: 5px;
                border-bottom: 1px solid var(--border-color);
            }
            .sidebar-tab {
                flex: 1;
                padding: 8px 5px;
                text-align: center;
                font-size: 14px;
                color: var(--text-secondary);
                border-radius: 10px;
                cursor: pointer;
                transition:
                    background-color 0.2s,
                    color 0.2s;
                position: relative;
            }
            .sidebar-tab.active {
                background-color: var(--primary-color);
                color: white;
                font-weight: 600;
            }
            .sidebar-tab .count-badge {
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: var(--accent-color);
                color: white;
                font-size: 10px;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                line-height: 18px;
                text-align: center;
            }

            .recipe-list-container {
                flex-grow: 1;
                overflow-y: auto;
                padding: 10px;
            }

            .recipe-list-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 8px;
                cursor: pointer;
                transition:
                    background-color 0.2s,
                    box-shadow 0.2s;
            }

            .recipe-list-item:hover {
                background-color: var(--border-color);
            }

            .recipe-list-item.active {
                background-color: var(--primary-color);
                color: white;
                box-shadow: 0 4px 12px rgba(140, 90, 59, 0.2);
            }

            .recipe-list-item.active .recipe-info span {
                color: white !important;
            }

            .recipe-info {
                display: flex;
                flex-direction: column;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .recipe-info strong {
                font-size: 15px;
                font-weight: 600;
            }

            .btn-delete-recipe {
                background: none;
                color: var(--text-secondary);
                border-radius: 50%;
                width: 24px;
                height: 24px;
                border: none;
                cursor: pointer;
                flex-shrink: 0;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 5px;
                visibility: hidden;
                opacity: 0;
            }
            .recipe-list-item:hover .btn-delete-recipe,
            .recipe-list-item.active .btn-delete-recipe {
                visibility: visible;
                opacity: 1;
            }
            .btn-delete-recipe:hover {
                background: var(--danger-color);
                color: white;
            }

            .btn-delete-recipe svg,
            .btn-delete-dough svg,
            .btn-remove svg {
                width: 100%;
                height: 100%;
            }
            .tab-delete-btn svg {
                width: 10px;
                height: 10px;
            }

            .sidebar-footer {
                padding: 15px;
                border-top: 1px solid var(--border-color);
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .card {
                background: var(--card-bg);
                padding: 20px;
                border-radius: 20px;
                margin-bottom: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
                position: relative;
            }
            .card-title-wrapper {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0 5px;
                margin-bottom: 20px;
            }
            .card-title {
                font-size: 18px;
                font-weight: 600;
                color: var(--text-primary);
            }
            .form-item {
                margin-bottom: 20px;
            }
            /* [G-Code-Note] 栅格布局 (新增) */
            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            .form-item-label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                color: #606266;
            }
            .input-field,
            .picker {
                width: 100%;
                height: 44px;
                line-height: 44px;
                padding: 0 12px;
                border: 1px solid var(--border-color);
                border-radius: 10px;
                font-size: 14px;
                background-color: #f8f9fa;
                box-sizing: border-box;
                color: var(--text-primary);
                transition:
                    border-color 0.2s,
                    box-shadow 0.2s;
            }
            .input-field.ratio-input {
                width: 100px;
                text-align: center;
                flex-shrink: 0;
            }

            .input-field:focus,
            .picker:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(140, 90, 59, 0.15);
            }

            .btn {
                display: inline-flex;
                justify-content: center;
                align-items: center;
                padding: 10px 15px;
                min-height: 44px;
                box-sizing: border-box;
                border-radius: 15px;
                font-size: 16px;
                font-weight: 500;
                text-align: center;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.28s;
                border: none;
            }
            .btn:active {
                transform: scale(0.97);
            }
            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                box-shadow: none;
                transform: none;
            }
            .btn-primary {
                background-image: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(140, 90, 59, 0.2);
            }
            .btn-secondary {
                background-color: #f3e9e3;
                color: var(--text-secondary);
            }
            .btn-full-width {
                width: 100%;
            }
            .btn-dashed {
                border: 1px dashed var(--primary-color);
                color: var(--primary-color);
                background: transparent;
                min-height: 46px;
            }
            .btn-remove {
                width: 40px;
                height: 40px;
                border: 1px dashed var(--border-color);
                border-radius: 10px;
                color: var(--danger-color);
                background: transparent;
                padding: 10px;
                min-height: auto;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            .ingredient-header {
                display: flex;
                align-items: center;
                color: var(--text-secondary);
                font-size: 13px;
                padding: 0 5px;
                margin-top: 15px;
                margin-bottom: 8px;
            }
            .col-name {
                flex: 1;
            }
            .col-ratio {
                width: 100px;
                text-align: center;
                margin-left: 10px;
            }
            .col-action {
                width: 40px;
                text-align: right;
            }
            .ingredient-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            .self-made-tag {
                position: absolute;
                top: 50%;
                right: 12px;
                transform: translateY(-50%);
                font-size: 10px;
                background-color: var(--accent-color);
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 500;
            }
            .input-with-tag-wrapper {
                position: relative;
                flex-grow: 1;
            }
            .input-with-tag-wrapper .input-field {
                padding-right: 50px;
            }

            .procedure-item {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            .procedure-notes .notes-title {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                color: #606266;
            }
            .sub-group {
                margin-top: 20px;
                border-top: 1px solid var(--border-color);
                padding-top: 20px;
            }
            .sub-group-title {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
                margin-bottom: 15px;
            }

            /* [G-Code-Note] 复用 .product-tabs-wrapper 样式用于版本管理 */
            .tabs-wrapper {
                position: relative;
                display: flex;
                align-items: center;
                margin-bottom: 20px;
            }
            .tabs {
                display: flex;
                gap: 10px;
                border-bottom: 1px solid var(--border-color);
                flex-wrap: nowrap;
                overflow-x: auto;
                scrollbar-width: none;
            }
            .tabs::-webkit-scrollbar {
                display: none;
            }
            .tab-item {
                padding: 10px 15px;
                cursor: pointer;
                color: var(--text-secondary);
                border-bottom: 3px solid transparent;
                transition:
                    color 0.3s,
                    border-color 0.3s;
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
            }
            .tab-item.active {
                color: var(--primary-color);
                border-bottom-color: var(--primary-color);
                font-weight: 600;
            }
            .add-tab {
                font-weight: bold;
                color: var(--primary-color);
            }
            .tab-delete-btn {
                background-color: var(--border-color);
                border-radius: 50%;
                border: none;
                padding: 0;
                margin: 0;
                width: 18px;
                height: 18px;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                visibility: hidden;
                opacity: 0;
            }
            .tab-item:hover .tab-delete-btn,
            .tab-item.active .tab-delete-btn {
                visibility: visible;
                opacity: 1;
            }
            .tab-delete-btn:hover {
                background-color: var(--danger-color);
                color: white;
            }
            .tab-scroll-btn {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                background-color: rgba(255, 255, 255, 0.8);
                border: 1px solid var(--border-color);
                border-radius: 50%;
                width: 28px;
                height: 28px;
                z-index: 10;
                cursor: pointer;
                color: var(--text-secondary);
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            }
            .tab-scroll-btn.left {
                left: -14px;
            }
            .tab-scroll-btn.right {
                right: -14px;
            }
            .tab-scroll-btn:hover {
                color: var(--primary-color);
            }

            .main-content {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px;
                position: relative;
            }
            .editor-placeholder {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                text-align: center;
                color: var(--text-secondary);
                font-size: 18px;
            }
            .btn-delete-dough {
                position: absolute;
                top: 20px;
                right: 20px;
                background: none;
                border: none;
                color: var(--primary-color);
                cursor: pointer;
                width: 24px;
                height: 24px;
                opacity: 0.8;
                transition: opacity 0.2s;
            }
            .btn-delete-dough:hover {
                opacity: 1;
            }

            .suggestion-box {
                position: absolute;
                background-color: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                z-index: 100;
                max-height: 200px;
                overflow-y: auto;
                list-style: none;
                margin: 0;
                padding: 5px;
                box-sizing: border-box;
            }
            .suggestion-item {
                padding: 8px 12px;
                font-size: 14px;
                cursor: pointer;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .suggestion-item:hover {
                background-color: var(--sidebar-bg);
            }
            .suggestion-tag {
                font-size: 10px;
                background-color: var(--accent-color);
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 500;
                margin-left: 8px;
            }
        </style>
    </head>

    <body>
        <svg style="display: none">
            <symbol id="icon-trash" viewBox="0 0 72 72">
                <path
                    style="fill: currentColor"
                    d="M31.4,5.9c-1.3,0-2.6,0.5-3.6,1.4c-0.9,0.9-1.4,2.3-1.4,3.6v2.5H11.5v5H14v39.8c0,4.1,3.4,7.5,7.5,7.5h29.8 c4.1,0,7.5-3.4,7.5-7.5V18.3h2.5v-5H46.3v-2.5c0-1.3-0.5-2.6-1.4-3.6s-2.3-1.4-3.6-1.4H31.4z M31.4,10.9h9.9v2.5h-9.9V10.9z M18.9,18.3h34.8v39.8c0,1.4-1.1,2.5-2.5,2.5H21.4c-1.4,0-2.5-1.1-2.5-2.5V18.3z M23.9,25.8v27.3h5V25.8H23.9z M33.9,25.8v27.3h5 V25.8H33.9z M43.8,25.8v27.3h5V25.8H43.8z"
                />
            </symbol>
            <symbol id="icon-close" viewBox="0 0 16 16">
                <line
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    x1="14"
                    y1="2"
                    x2="2"
                    y2="14"
                />
                <line
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    x1="2"
                    y1="2"
                    x2="14"
                    y2="14"
                />
            </symbol>
        </svg>

        <div id="app">
            <aside class="sidebar">
                <header class="sidebar-header">
                    <h1>配方工作区</h1>
                    <p>打开、编辑并保存您的配方</p>
                </header>

                <div class="sidebar-tabs">
                    <div
                        class="sidebar-tab"
                        :class="{active: activeCategory === 'MAIN'}"
                        @click="activeCategory = 'MAIN'"
                    >
                        产品配方
                        <span v-if="recipeCategories.main.length > 0" class="count-badge"
                            >{{ recipeCategories.main.length }}</span
                        >
                    </div>
                    <div
                        class="sidebar-tab"
                        :class="{active: activeCategory === 'PRE_DOUGH'}"
                        @click="activeCategory = 'PRE_DOUGH'"
                    >
                        面种
                        <span v-if="recipeCategories.preDough.length > 0" class="count-badge"
                            >{{ recipeCategories.preDough.length }}</span
                        >
                    </div>
                    <div
                        class="sidebar-tab"
                        :class="{active: activeCategory === 'EXTRA'}"
                        @click="activeCategory = 'EXTRA'"
                    >
                        馅料
                        <span v-if="recipeCategories.extra.length > 0" class="count-badge"
                            >{{ recipeCategories.extra.length }}</span
                        >
                    </div>
                </div>

                <div class="recipe-list-container">
                    <div
                        v-for="family in filteredFamilies"
                        :key="family.id"
                        class="recipe-list-item"
                        :class="{ active: currentFamily && currentFamily.id === family.id }"
                        @click="selectFamily(family.id)"
                    >
                        <div class="recipe-info">
                            <strong>
                                {{ family.name || `未命名配方` }}
                                <span
                                    v-if="isFamilyDirty(family)"
                                    style="color: var(--danger-color); margin-left: 4px"
                                    >*</span
                                >
                            </strong>
                        </div>
                        <button class="btn-delete-recipe" @click.stop="deleteFamily(family.id)">
                            <svg><use href="#icon-trash"></use></svg>
                        </button>
                    </div>
                </div>

                <footer class="sidebar-footer">
                    <button class="btn btn-dashed btn-full-width" @click="addFamily()">+ 新增配方</button>
                    <button class="btn btn-secondary btn-full-width" @click="openFile" v-if="isFSApiSupported">
                        打开文件
                    </button>
                    <button
                        class="btn btn-primary btn-full-width"
                        @click="saveFile"
                        v-if="isFSApiSupported"
                        :disabled="!fileHandle"
                        style="grid-column: 1 / -1"
                    >
                        保存文件
                    </button>

                    <template v-if="!isFSApiSupported">
                        <button class="btn btn-secondary btn-full-width" @click="triggerImport">导入JSON</button>
                        <button
                            class="btn btn-primary btn-full-width"
                            @click="exportAllJson"
                            :disabled="recipes.length === 0"
                            style="grid-column: 1 / -1"
                        >
                            导出JSON
                        </button>
                    </template>
                    <input
                        type="file"
                        ref="fileInput"
                        @change="handleFileImport"
                        accept=".json"
                        style="display: none"
                    />
                </footer>
            </aside>

            <main class="main-content" ref="mainContentRef">
                <div v-if="currentFamily && currentVersion" class="editor-content">
                    <div class="card">
                        <div class="form-grid">
                            <div class="form-item" style="margin-bottom: 0">
                                <label class="form-item-label">配方名称 (配方族)</label>
                                <input
                                    class="input-field"
                                    v-model="currentFamily.name"
                                    :placeholder="recipeNamePlaceholder"
                                />
                            </div>
                            <div class="form-item" style="margin-bottom: 0">
                                <label class="form-item-label">配方类型</label>
                                <input
                                    class="input-field"
                                    :value="recipeTypeDisplay(currentFamily.type)"
                                    readonly
                                    disabled
                                />
                            </div>
                        </div>
                        <div v-if="currentFamily.type === 'MAIN'" class="form-item" style="margin-top: 20px">
                            <label class="form-item-label">配方品类</label>
                            <select class="picker" v-model="currentFamily.category">
                                <option v-for="cat in mainRecipeCategories" :key="cat.value" :value="cat.value">
                                    {{ cat.text }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title-wrapper" style="margin-bottom: 10px">
                            <span class="card-title">版本管理</span>
                        </div>
                        <div class="tabs-wrapper">
                            <button
                                v-if="tabScrollState.version.showLeft"
                                class="tab-scroll-btn left"
                                @click="scrollVersionTabs(-150)"
                            >
                                &lt;
                            </button>
                            <div class="tabs" ref="versionTabsRef" @scroll="updateVersionTabScrollButtons">
                                <div
                                    v-for="(version, index) in currentFamily.versions"
                                    :key="version.id"
                                    class="tab-item"
                                    :class="{ active: currentVersionIndex === index }"
                                    @click="currentVersionIndex = index"
                                >
                                    <span>{{ version.notes || `版本 ${index + 1}` }}</span>
                                    <button class="tab-delete-btn" @click.stop="deleteVersion(index)">
                                        <svg><use href="#icon-close"></use></svg>
                                    </button>
                                </div>
                                <div class="tab-item add-tab" @click="addVersion">+</div>
                            </div>
                            <button
                                v-if="tabScrollState.version.showRight"
                                class="tab-scroll-btn right"
                                @click="scrollVersionTabs(150)"
                            >
                                &gt;
                            </button>
                        </div>
                        <div class="form-item" style="margin-top: 20px; margin-bottom: 0">
                            <label class="form-item-label">版本备注 (例如: V1 - 冬季配方)</label>
                            <input class="input-field" v-model="currentVersion.notes" placeholder="输入备注" />
                        </div>
                    </div>

                    <div v-if="currentFamily.type === 'MAIN'">
                        <template v-if="currentFamily.category === 'BREAD'">
                            <div v-for="(dough, doughIndex) in processedPreDoughs" :key="dough.id" class="card">
                                <button class="btn-delete-dough" @click="removePreDough(doughIndex)">
                                    <svg><use href="#icon-close"></use></svg>
                                </button>
                                <div class="card-title-wrapper">
                                    <span class="card-title">{{ dough.name }}</span>
                                </div>
                                <div class="form-item">
                                    <label class="form-item-label">面种中面粉占总面粉的百分比 (%)</label>
                                    <input
                                        class="input-field"
                                        type="number"
                                        v-model.number="dough.flourRatioInMainDough"
                                        placeholder="例如: 20"
                                    />
                                </div>

                                <div class="ingredient-header" style="opacity: 0.7; padding: 0 5px; margin-top: 0">
                                    <span class="col-name">原料 (换算后，基于主面团总面粉)</span>
                                    <span class="col-ratio">比例 %</span>
                                </div>

                                <div
                                    v-for="ing in dough.calculatedIngredients"
                                    :key="ing.id"
                                    class="ingredient-row"
                                    style="opacity: 0.7"
                                >
                                    <input class="input-field" :value="ing.name" readonly />
                                    <input
                                        class="input-field ratio-input"
                                        type="number"
                                        :value="ing.calculatedRatio"
                                        readonly
                                    />
                                </div>
                            </div>
                            <button
                                class="btn btn-dashed btn-full-width"
                                style="margin-bottom: 20px"
                                @click="openAddPreDoughModal"
                            >
                                + 添加面种引用
                            </button>
                        </template>

                        <div class="card">
                            <div class="card-title-wrapper">
                                <span class="card-title">{{ recipeContentTitle }}</span>
                            </div>
                            <div v-if="currentFamily.category === 'BREAD'" class="form-item">
                                <label class="form-item-label">面团出缸温度 (°C)</label>
                                <input
                                    class="input-field"
                                    type="number"
                                    v-model.number="currentVersion.targetTemp"
                                    placeholder="例如: 26"
                                />
                            </div>
                            <div class="form-item">
                                <label class="form-item-label">工艺损耗率 (%)</label
                                ><input
                                    class="input-field"
                                    type="number"
                                    v-model.number="mainDough.lossRatio"
                                    placeholder="例如: 1"
                                />
                            </div>
                            <div class="form-item">
                                <label class="form-item-label">分割损耗 (g)</label
                                ><input
                                    class="input-field"
                                    type="number"
                                    v-model.number="mainDough.divisionLoss"
                                    placeholder="例如: 2"
                                />
                            </div>
                            <div class="ingredient-header">
                                <span class="col-name">原料名称</span>
                                <span class="col-ratio">比例 %</span>
                                <span class="col-action"></span>
                            </div>
                            <div v-for="(ing, index) in mainDough.ingredients" :key="ing.id" class="ingredient-row">
                                <input
                                    class="input-field"
                                    v-model="ing.name"
                                    placeholder="输入原料名称"
                                    @focus="handleIngredientInput(ing, $event)"
                                    @input="handleIngredientInput(ing, $event)"
                                    @blur="handleIngredientBlur(ing)"
                                />
                                <input
                                    class="input-field ratio-input"
                                    type="number"
                                    v-model.number="ing.ratio"
                                    placeholder="%"
                                />
                                <button class="btn btn-remove" @click="removeMainDoughIngredient(index)">
                                    <svg><use href="#icon-trash"></use></svg>
                                </button>
                            </div>
                            <button class="btn btn-dashed btn-full-width" @click="addMainDoughIngredient">
                                + 添加原料
                            </button>
                            <div class="procedure-notes sub-group">
                                <span class="notes-title">制作要点:</span>
                                <div v-for="(step, index) in mainDough.procedure" :key="index" class="procedure-item">
                                    <input
                                        class="input-field"
                                        v-model="mainDough.procedure[index]"
                                        placeholder="输入制作步骤"
                                    />
                                    <button class="btn btn-remove" @click="removeMainDoughProcedureStep(index)">
                                        <svg><use href="#icon-trash"></use></svg>
                                    </button>
                                </div>
                                <button class="btn btn-dashed btn-full-width" @click="addMainDoughProcedureStep">
                                    + 添加要点
                                </button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-title-wrapper"><span class="card-title">产品列表</span></div>
                            <div class="tabs-wrapper">
                                <button
                                    v-if="tabScrollState.product.showLeft"
                                    class="tab-scroll-btn left"
                                    @click="scrollProductTabs(-150)"
                                >
                                    &lt;
                                </button>
                                <div class="tabs" ref="productTabsRef" @scroll="updateProductTabScrollButtons">
                                    <div
                                        v-for="(product, index) in currentVersion.products"
                                        :key="product.id"
                                        class="tab-item"
                                        :class="{ active: activeProductTab === index }"
                                        @click="activeProductTab = index"
                                    >
                                        <span>{{ product.name || `产品${index + 1}` }}</span>
                                        <button class="tab-delete-btn" @click.stop="deleteProduct(index)">
                                            <svg><use href="#icon-close"></use></svg>
                                        </button>
                                    </div>
                                    <div class="tab-item add-tab" @click="addProduct">+</div>
                                </div>
                                <button
                                    v-if="tabScrollState.product.showRight"
                                    class="tab-scroll-btn right"
                                    @click="scrollProductTabs(150)"
                                >
                                    &gt;
                                </button>
                            </div>

                            <div v-if="currentVersion.products.length > 0">
                                <div
                                    v-for="(product, prodIndex) in currentVersion.products"
                                    v-show="activeProductTab === prodIndex"
                                    :key="product.id"
                                >
                                    <div class="form-item">
                                        <label class="form-item-label">产品名称</label
                                        ><input
                                            class="input-field"
                                            v-model="product.name"
                                            :placeholder="`产品${prodIndex + 1}`"
                                        />
                                    </div>
                                    <div class="form-item">
                                        <label class="form-item-label">基础原料克重 (g)</label
                                        ><input
                                            class="input-field"
                                            type="number"
                                            v-model.number="product.baseDoughWeight"
                                            placeholder="例如: 100"
                                        />
                                    </div>
                                    <div class="sub-group">
                                        <h4 class="sub-group-title">辅料 (Mix-ins) - 配方百分比</h4>
                                        <div
                                            v-for="(ing, ingIndex) in product.mixIns"
                                            :key="ing.id"
                                            class="ingredient-row"
                                        >
                                            <div class="input-with-tag-wrapper">
                                                <input
                                                    class="input-field"
                                                    v-model="ing.name"
                                                    placeholder="输入辅料名称"
                                                    @focus="handleIngredientInput(ing, $event)"
                                                    @input="handleIngredientInput(ing, $event)"
                                                    @blur="handleIngredientBlur(ing)"
                                                />
                                                <span v-if="isSelfMade(ing.name)" class="self-made-tag">自制</span>
                                            </div>
                                            <input
                                                class="input-field ratio-input"
                                                type="number"
                                                v-model.number="ing.ratio"
                                                placeholder="%"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeSubIngredient(prodIndex, 'mixIns', ingIndex)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addSubIngredient(prodIndex, 'mixIns')"
                                        >
                                            + 添加辅料
                                        </button>
                                    </div>
                                    <div class="sub-group">
                                        <h4 class="sub-group-title">馅料 (Fillings) - 克/个</h4>
                                        <div
                                            v-for="(ing, ingIndex) in product.fillings"
                                            :key="ing.id"
                                            class="ingredient-row"
                                        >
                                            <div class="input-with-tag-wrapper">
                                                <input
                                                    class="input-field"
                                                    v-model="ing.name"
                                                    placeholder="输入馅料名称"
                                                    @focus="handleIngredientInput(ing, $event)"
                                                    @input="handleIngredientInput(ing, $event)"
                                                    @blur="handleIngredientBlur(ing)"
                                                />
                                                <span v-if="isSelfMade(ing.name)" class="self-made-tag">自制</span>
                                            </div>
                                            <input
                                                class="input-field ratio-input"
                                                type="number"
                                                v-model.number="ing.weightInGrams"
                                                placeholder="g/个"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeSubIngredient(prodIndex, 'fillings', ingIndex)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addSubIngredient(prodIndex, 'fillings')"
                                        >
                                            + 添加馅料
                                        </button>
                                    </div>
                                    <div class="sub-group">
                                        <h4 class="sub-group-title">表面装饰 (Toppings) - 克/个</h4>
                                        <div
                                            v-for="(ing, ingIndex) in product.toppings"
                                            :key="ing.id"
                                            class="ingredient-row"
                                        >
                                            <div class="input-with-tag-wrapper">
                                                <input
                                                    class="input-field"
                                                    v-model="ing.name"
                                                    placeholder="输入装饰名称"
                                                    @focus="handleIngredientInput(ing, $event)"
                                                    @input="handleIngredientInput(ing, $event)"
                                                    @blur="handleIngredientBlur(ing)"
                                                />
                                                <span v-if="isSelfMade(ing.name)" class="self-made-tag">自制</span>
                                            </div>
                                            <input
                                                class="input-field ratio-input"
                                                type="number"
                                                v-model.number="ing.weightInGrams"
                                                placeholder="g/个"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeSubIngredient(prodIndex, 'toppings', ingIndex)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addSubIngredient(prodIndex, 'toppings')"
                                        >
                                            + 添加表面装饰
                                        </button>
                                    </div>
                                    <div class="procedure-notes sub-group">
                                        <span class="notes-title">产品制作要点:</span>
                                        <div
                                            v-for="(step, stepIndex) in product.procedure"
                                            :key="stepIndex"
                                            class="procedure-item"
                                        >
                                            <input
                                                class="input-field"
                                                v-model="product.procedure[stepIndex]"
                                                placeholder="输入制作步骤"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeProductProcedureStep(prodIndex, stepIndex)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addProductProcedureStep(prodIndex)"
                                        >
                                            + 添加要点
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="editor-placeholder">
                                <p>暂无产品<br />点击上方的 "+" 添加一个新产品</p>
                            </div>
                        </div>
                    </div>

                    <div v-else>
                        <div class="card">
                            <div class="card-title-wrapper"><span class="card-title">原料列表</span></div>
                            <div class="form-item">
                                <label class="form-item-label">工艺损耗率 (%)</label>
                                <input
                                    class="input-field"
                                    type="number"
                                    v-model.number="currentVersion.lossRatio"
                                    placeholder="例如: 1"
                                />
                            </div>
                            <div class="ingredient-header">
                                <span class="col-name">原料名称</span>
                                <span class="col-ratio">比例 %</span>
                                <span class="col-action"></span>
                            </div>
                            <div
                                v-for="(ing, index) in currentVersion.ingredients"
                                :key="ing.id"
                                class="ingredient-row"
                            >
                                <input
                                    class="input-field"
                                    v-model="ing.name"
                                    placeholder="输入原料名称"
                                    @focus="handleIngredientInput(ing, $event)"
                                    @input="handleIngredientInput(ing, $event)"
                                    @blur="handleIngredientBlur(ing)"
                                />
                                <input
                                    class="input-field ratio-input"
                                    type="number"
                                    v-model.number="ing.ratio"
                                    placeholder="%"
                                />
                                <button class="btn btn-remove" @click="removeOtherIngredient(index)">
                                    <svg><use href="#icon-trash"></use></svg>
                                </button>
                            </div>
                            <button class="btn btn-dashed btn-full-width" @click="addOtherIngredient">
                                + 添加原料
                            </button>
                            <div class="procedure-notes sub-group">
                                <span class="notes-title">制作要点:</span>
                                <div
                                    v-for="(step, index) in currentVersion.procedure"
                                    :key="index"
                                    class="procedure-item"
                                >
                                    <input
                                        class="input-field"
                                        v-model="currentVersion.procedure[index]"
                                        placeholder="输入制作步骤"
                                    />
                                    <button class="btn btn-remove" @click="removeOtherProcedureStep(index)">
                                        <svg><use href="#icon-trash"></use></svg>
                                    </button>
                                </div>
                                <button class="btn btn-dashed btn-full-width" @click="addOtherProcedureStep">
                                    + 添加要点
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="editor-placeholder">
                    <p>← 从左侧选择一个配方进行编辑<br />或新增一个配方</p>
                </div>

                <ul v-if="suggestionState.visible" class="suggestion-box" :style="suggestionBoxStyle">
                    <li
                        v-for="sugg in suggestionState.suggestions"
                        :key="sugg.name"
                        class="suggestion-item"
                        @mousedown="selectSuggestion(sugg)"
                    >
                        <span>{{ sugg.name }}</span>
                        <span v-if="sugg.selfMade" class="suggestion-tag">自制</span>
                    </li>
                </ul>
            </main>

            <div v-if="isAddPreDoughModalVisible" class="modal-overlay" @click="isAddPreDoughModalVisible = false">
                <div class="modal-content" @click.stop>
                    <div class="modal-header">选择要引用的面种</div>
                    <div class="modal-body">
                        <div
                            v-for="dough in availablePreDoughsForReferencing"
                            :key="dough.id"
                            class="recipe-list-item"
                            @click="addPreDoughReference(dough)"
                        >
                            <div class="recipe-info"><strong>{{ dough.name }}</strong></div>
                        </div>
                        <div
                            v-if="availablePreDoughsForReferencing.length === 0"
                            style="text-align: center; color: var(--text-secondary)"
                        >
                            暂无可引用的面种
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="isAddPreDoughModalVisible = false">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const { createApp, ref, computed, watch, nextTick, onMounted, onUnmounted } = Vue;

            createApp({
                setup() {
                    let nextRecipeId = 1;
                    let nextIngredientId = 1000;
                    let nextVersionId = 10000; // [G-Code-Note] 新增

                    const recipes = ref([]); // [G-Code-Note] 现在是 '配方族' (Families) 数组
                    const currentFamilyId = ref(null); // [G-Code-Note] 替换 currentRecipeId
                    const currentVersionIndex = ref(0); // [G-Code-Note] 新增，跟踪当前激活的版本
                    const activeProductTab = ref(0);
                    const fileInput = ref(null);
                    const isAddPreDoughModalVisible = ref(false);
                    const activeCategory = ref('MAIN');
                    const mainContentRef = ref(null);
                    const productTabsRef = ref(null);
                    const versionTabsRef = ref(null); // [G-Code-Note] 新增
                    const fileHandle = ref(null);

                    const savedRecipeSnapshots = ref(new Map());
                    const isFSApiSupported = computed(() => 'showOpenFilePicker' in window);

                    // [G-Code-Note] 检查 Family 是否被修改
                    const isFamilyDirty = (family) => {
                        if (!family) return false;
                        const savedSnapshot = savedRecipeSnapshots.value.get(family.id);
                        if (!savedSnapshot) {
                            return true; // 新增的
                        }
                        return JSON.stringify(family) !== savedSnapshot;
                    };

                    const isDirty = computed(() => {
                        if (recipes.value.length !== savedRecipeSnapshots.value.size) {
                            return true;
                        }
                        return recipes.value.some((family) => isFamilyDirty(family));
                    });

                    // [G-Code-Note] 拆分 tabs 滚动状态
                    const tabScrollState = ref({
                        version: { showLeft: false, showRight: false },
                        product: { showLeft: false, showRight: false },
                    });

                    const categoryDisplayMap = {
                        BREAD: '面包类',
                        PASTRY: '西点类',
                        DESSERT: '甜品类',
                        DRINK: '饮品类',
                        OTHER: '其他',
                    };
                    const categoryDisplay = (category) => categoryDisplayMap[category] || '未知品类';

                    const mainRecipeCategories = ref(
                        Object.entries(categoryDisplayMap)
                            .filter(([key]) => key !== 'OTHER')
                            .map(([value, text]) => ({ value, text })),
                    );

                    const predefinedIngredients = ref([
                        { name: '面包粉', isFlour: true, waterContent: 0 },
                        { name: '高筋粉', isFlour: true, waterContent: 0 },
                        { name: '中筋粉', isFlour: true, waterContent: 0 },
                        { name: '全麦粉', isFlour: true, waterContent: 0 },
                        { name: '裸麦粉', isFlour: true, waterContent: 0 },
                        { name: '黑麦粉', isFlour: true, waterContent: 0 },
                        { name: 'T45', isFlour: true, waterContent: 0 },
                        { name: 'T55', isFlour: true, waterContent: 0 },
                        { name: 'T65', isFlour: true, waterContent: 0 },
                        { name: 'T80', isFlour: true, waterContent: 0 },
                        { name: 'T110', isFlour: true, waterContent: 0 },
                        { name: 'T150', isFlour: true, waterContent: 0 },
                        { name: 'T170', isFlour: true, waterContent: 0 },
                        { name: '水', isFlour: false, waterContent: 1 },
                        { name: '牛奶', isFlour: false, waterContent: 0.87 },
                        { name: '淡奶油', isFlour: false, waterContent: 0.6 },
                        { name: '蜂蜜', isFlour: false, waterContent: 0.17 },
                        { name: '炼乳', isFlour: false, waterContent: 0.27 },
                        { name: '鸡蛋', isFlour: false, waterContent: 0.75 },
                        { name: '全蛋', isFlour: false, waterContent: 0.75 },
                        { name: '蛋黄', isFlour: false, waterContent: 0.5 },
                        { name: '蛋清', isFlour: false, waterContent: 0.88 },
                        { name: '蛋白', isFlour: false, waterContent: 0.88 },
                        { name: '白砂糖', isFlour: false, waterContent: 0 },
                        { name: '盐', isFlour: false, waterContent: 0 },
                        { name: '即发干酵母', isFlour: false, waterContent: 0 },
                        { name: '鲜酵母', isFlour: false, waterContent: 0 },
                        { name: '黄油', isFlour: false, waterContent: 0 },
                        { name: '奶粉', isFlour: false, waterContent: 0 },
                        { name: '麦芽精', isFlour: false, waterContent: 0 },
                    ]);

                    const allAvailableIngredients = computed(() => {
                        const ingredientsMap = new Map();
                        predefinedIngredients.value.forEach((ing) => {
                            ingredientsMap.set(ing.name, { ...ing, selfMade: false });
                        });
                        recipes.value
                            .filter((r) => r.type !== 'MAIN' && r.name)
                            .forEach((recipe) => {
                                ingredientsMap.set(recipe.name, {
                                    name: recipe.name,
                                    isFlour: false,
                                    waterContent: 0,
                                    selfMade: true,
                                });
                            });
                        return Array.from(ingredientsMap.values());
                    });

                    const suggestionState = ref({
                        visible: false,
                        suggestions: [],
                        target: null,
                        ingRef: null,
                    });
                    const suggestionBoxStyle = ref({});

                    watch(
                        () => suggestionState.value.target,
                        (newTarget) => {
                            if (!newTarget || !mainContentRef.value) {
                                suggestionState.value.visible = false;
                                return;
                            }
                            const targetRect = newTarget.getBoundingClientRect();
                            const parentRect = mainContentRef.value.getBoundingClientRect();

                            suggestionBoxStyle.value = {
                                top: `${targetRect.bottom - parentRect.top + mainContentRef.value.scrollTop}px`,
                                left: `${targetRect.left - parentRect.left}px`,
                                width: `${targetRect.width}px`,
                            };
                        },
                    );

                    // --- [G-Code-Note] 核心状态重构 ---
                    const currentFamilyIndex = computed(() =>
                        recipes.value.findIndex((r) => r.id === currentFamilyId.value),
                    );
                    const currentFamily = computed(() =>
                        currentFamilyIndex.value > -1 ? recipes.value[currentFamilyIndex.value] : null,
                    );
                    const currentVersion = computed(() =>
                        currentFamily.value
                            ? currentFamily.value.versions[currentVersionIndex.value]
                            : null,
                    );
                    // ------------------------------------

                    const mainDough = computed(() =>
                        currentFamily.value?.type === 'MAIN' && currentVersion.value
                            ? currentVersion.value.doughs.find((d) => d.type === 'MAIN_DOUGH')
                            : null,
                    );

                    const processedPreDoughs = computed(() => {
                        if (
                            !currentFamily.value ||
                            currentFamily.value.type !== 'MAIN' ||
                            !currentVersion.value
                        ) {
                            return [];
                        }
                        const preDoughs = currentVersion.value.doughs.filter((d) => d.type === 'PRE_DOUGH');

                        return preDoughs.map((dough) => {
                            const totalFlourRatioInPreDough = dough.ingredients
                                .filter((ing) => ing.isFlour)
                                .reduce((sum, ing) => sum + (ing.ratio || 0), 0);

                            if (totalFlourRatioInPreDough === 0) {
                                return {
                                    ...dough,
                                    calculatedIngredients: dough.ingredients.map((ing) => ({
                                        ...ing,
                                        calculatedRatio: ing.ratio,
                                    })),
                                };
                            }

                            const flourRatioInMainDough = dough.flourRatioInMainDough || 0;

                            const calculatedIngredients = dough.ingredients.map((ing) => {
                                const calculatedRatio =
                                    ((ing.ratio || 0) / totalFlourRatioInPreDough) * flourRatioInMainDough;

                                return {
                                    ...ing,
                                    calculatedRatio: parseFloat(calculatedRatio.toFixed(3)),
                                };
                            });

                            return {
                                ...dough,
                                calculatedIngredients,
                            };
                        });
                    });

                    const recipeContentTitle = computed(() => {
                        if (!currentFamily.value) return '';
                        if (currentFamily.value.category === 'BREAD') return '主面团';
                        return '配方内容';
                    });

                    const recipeCategories = computed(() => ({
                        main: recipes.value.filter((r) => r.type === 'MAIN'),
                        preDough: recipes.value.filter((r) => r.type === 'PRE_DOUGH'),
                        extra: recipes.value.filter((r) => r.type === 'EXTRA'),
                    }));

                    // [G-Code-Note] 重命名为 filteredFamilies
                    const filteredFamilies = computed(() => {
                        return recipes.value.filter((r) => r.type === activeCategory.value);
                    });

                    const recipeNamePlaceholder = computed(() =>
                        !currentFamily.value
                            ? ''
                            : { MAIN: '例如：法式长棍', PRE_DOUGH: '例如：波兰种', EXTRA: '例如：奶酥馅' }[
                                  currentFamily.value.type
                              ] || '配方名称',
                    );
                    const recipeTypeDisplay = (type) =>
                        ({ MAIN: '产品配方', PRE_DOUGH: '面种', EXTRA: '馅料/其他' })[type];

                    const selfMadeRecipeNames = computed(
                        () => new Set(recipes.value.filter((r) => r.type !== 'MAIN').map((r) => r.name)),
                    );
                    const isSelfMade = (name) => selfMadeRecipeNames.value.has(name);

                    const availablePreDoughs = computed(() => recipes.value.filter((r) => r.type === 'PRE_DOUGH'));

                    const availablePreDoughsForReferencing = computed(() => {
                        if (
                            !currentFamily.value ||
                            currentFamily.value.type !== 'MAIN' ||
                            !currentVersion.value
                        )
                            return [];
                        const existingDoughNames = new Set(
                            currentVersion.value.doughs.filter((d) => d.type === 'PRE_DOUGH').map((d) => d.name),
                        );
                        return availablePreDoughs.value.filter((d) => !existingDoughNames.has(d.name));
                    });

                    // [G-Code-Note] 监听 'currentVersion.products'
                    watch(
                        () => currentVersion.value?.products,
                        () => {
                            nextTick(() => {
                                updateProductTabScrollButtons();
                            });
                        },
                        { deep: true },
                    );

                    // [G-Code-Note] 监听 'currentFamily' (用于版本) 和 'currentVersionIndex'
                    watch([currentFamily, currentVersionIndex], () => {
                        if (currentFamily.value) {
                            nextTick(() => {
                                updateVersionTabScrollButtons();
                                if (currentFamily.value.type === 'MAIN') {
                                    activeProductTab.value = 0;
                                    updateProductTabScrollButtons();
                                }
                            });
                        }
                    });

                    // [G-Code-Note] 更新版本 Tab 滚动按钮
                    const updateVersionTabScrollButtons = () => {
                        const el = versionTabsRef.value;
                        if (!el) {
                            tabScrollState.value.version = { showLeft: false, showRight: false };
                            return;
                        }
                        const hasOverflow = el.scrollWidth > el.clientWidth;
                        tabScrollState.value.version.showLeft = hasOverflow && el.scrollLeft > 0;
                        tabScrollState.value.version.showRight =
                            hasOverflow && el.scrollLeft < el.scrollWidth - el.clientWidth - 1;
                    };
                    // [G-Code-Note] 滚动版本 Tab
                    const scrollVersionTabs = (amount) => {
                        versionTabsRef.value?.scrollBy({ left: amount, behavior: 'smooth' });
                    };

                    // [G-Code-Note] 更新产品 Tab 滚动按钮
                    const updateProductTabScrollButtons = () => {
                        const el = productTabsRef.value;
                        if (!el) {
                            tabScrollState.value.product = { showLeft: false, showRight: false };
                            return;
                        }
                        const hasOverflow = el.scrollWidth > el.clientWidth;
                        tabScrollState.value.product.showLeft = hasOverflow && el.scrollLeft > 0;
                        tabScrollState.value.product.showRight =
                            hasOverflow && el.scrollLeft < el.scrollWidth - el.clientWidth - 1;
                    };
                    // [G-Code-Note] 滚动产品 Tab
                    const scrollProductTabs = (amount) => {
                        productTabsRef.value?.scrollBy({ left: amount, behavior: 'smooth' });
                    };

                    // [G-Code-Note] 重构：getNewVersion (创建新版本的模板)
                    function getNewVersion(type, category = 'BREAD') {
                        const commonIngredient = {
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            isFlour: false,
                            waterContent: 0,
                        };

                        if (type === 'MAIN') {
                            return {
                                id: nextVersionId++,
                                notes: `V${nextVersionId}`, // 初始备注
                                targetTemp: null,
                                doughs: [
                                    {
                                        id: nextIngredientId++,
                                        name: '主面团',
                                        type: 'MAIN_DOUGH',
                                        lossRatio: 1,
                                        divisionLoss: 2,
                                        ingredients: [JSON.parse(JSON.stringify(commonIngredient))],
                                        procedure: [''],
                                    },
                                ],
                                products: [
                                    {
                                        id: nextRecipeId++,
                                        name: '产品1',
                                        baseDoughWeight: 100,
                                        mixIns: [],
                                        fillings: [],
                                        toppings: [],
                                        procedure: [''],
                                    },
                                ],
                            };
                        }
                        return {
                            id: nextVersionId++,
                            notes: `V${nextVersionId}`, // 初始备注
                            lossRatio: null,
                            ingredients: [JSON.parse(JSON.stringify(commonIngredient))],
                            procedure: [''],
                        };
                    }

                    // [G-Code-Note] 重构：getNewFamily (创建新配方族的模板)
                    function getNewFamily(type) {
                        const id = nextRecipeId++;
                        const category = type === 'MAIN' ? 'BREAD' : 'OTHER';
                        const firstVersion = getNewVersion(type, category);
                        firstVersion.notes = 'V1 - 初始版本'; // 第一个版本备注

                        return {
                            id,
                            name: '',
                            type: type,
                            category,
                            versions: [firstVersion],
                        };
                    }

                    // [G-Code-Note] 重构：addFamily (替换 addRecipe)
                    const addFamily = () => {
                        const newFamily = getNewFamily(activeCategory.value);
                        recipes.value.push(newFamily);
                        selectFamily(newFamily.id); // [G-Code-Note] 调用 selectFamily
                    };

                    // [G-Code-Note] 重构：selectFamily (替换 selectRecipe)
                    const selectFamily = (id) => {
                        suggestionState.value.visible = false;
                        currentFamilyId.value = id;
                        currentVersionIndex.value = 0; // 默认选中第一个版本
                    };

                    // [G-Code-Note] 重构：deleteFamily (替换 deleteRecipe)
                    const deleteFamily = (id) => {
                        const index = recipes.value.findIndex((r) => r.id === id);
                        if (index === -1) return;
                        if (!confirm(`确定要删除 "${recipes.value[index].name || '未命名配方'}" 吗？`)) return;
                        if (currentFamilyId.value === id) {
                            currentFamilyId.value = null;
                            currentVersionIndex.value = 0;
                        }

                        savedRecipeSnapshots.value.delete(id); // 从快照中也删除
                        recipes.value.splice(index, 1);
                    };

                    // [G-Code-Note] 新增：addVersion
                    const addVersion = () => {
                        if (!currentFamily.value) return;
                        // 复制当前版本作为模板
                        const newVersion = JSON.parse(JSON.stringify(currentVersion.value));
                        // 分配新 ID
                        newVersion.id = nextVersionId++;
                        newVersion.notes = `${currentVersion.value.notes} (副本)`;
                        // TODO: 深度复制时需要为所有子项分配新 ID
                        // (为了简化，这个工具目前依赖浅层复制ID，但对于纯JSON是安全的)
                        currentFamily.value.versions.push(newVersion);
                        nextTick(() => {
                            currentVersionIndex.value = currentFamily.value.versions.length - 1;
                        });
                    };

                    // [G-Code-Note] 新增：deleteVersion
                    const deleteVersion = (index) => {
                        if (!currentFamily.value || currentFamily.value.versions.length <= 1) {
                            alert('必须至少保留一个版本。');
                            return;
                        }
                        const versionNotes = currentFamily.value.versions[index].notes || `版本 ${index + 1}`;
                        if (!confirm(`确定要删除版本 "${versionNotes}" 吗？`)) return;

                        currentFamily.value.versions.splice(index, 1);
                        if (currentVersionIndex.value >= currentFamily.value.versions.length) {
                            currentVersionIndex.value = currentFamily.value.versions.length - 1;
                        }
                    };

                    const openAddPreDoughModal = () => {
                        isAddPreDoughModalVisible.value = true;
                    };
                    const addPreDoughReference = (dough) => {
                        // [G-Code-Note] 绑定到 currentVersion
                        currentVersion.value.doughs.push({
                            ...JSON.parse(JSON.stringify(dough.versions[0])), // 假设引用面种的V1
                            id: nextRecipeId++,
                            name: dough.name, // Family name
                            type: 'PRE_DOUGH',
                            flourRatioInMainDough: 20,
                        });
                        isAddPreDoughModalVisible.value = false;
                    };
                    const removePreDough = (index) => {
                        // [G-Code-Note] 绑定到 currentVersion
                        const preDoughs = currentVersion.value.doughs.filter((d) => d.type === 'PRE_DOUGH');
                        const doughToRemove = preDoughs[index];
                        const originalIndex = currentVersion.value.doughs.findIndex((d) => d === doughToRemove);
                        if (originalIndex > -1) {
                            currentVersion.value.doughs.splice(originalIndex, 1);
                        }
                    };

                    const handleIngredientInput = (ingredient, event) => {
                        const query = event.target.value;
                        suggestionState.value.ingRef = ingredient;
                        suggestionState.value.target = event.target;

                        if (!query) {
                            suggestionState.value.visible = false;
                            suggestionState.value.suggestions = [];
                            return;
                        }

                        const filtered = allAvailableIngredients.value.filter((p) =>
                            p.name.toLowerCase().includes(query.toLowerCase()),
                        );

                        suggestionState.value.suggestions = filtered;
                        suggestionState.value.visible = filtered.length > 0;
                    };

                    const handleIngredientBlur = (ingredient) => {
                        if (ingredient.name) {
                            const perfectMatch = allAvailableIngredients.value.find((p) => p.name === ingredient.name);
                            if (perfectMatch) {
                                ingredient.isFlour = perfectMatch.isFlour;
                                ingredient.waterContent = perfectMatch.waterContent;
                            }
                        }
                        setTimeout(() => {
                            if (suggestionState.value) {
                                suggestionState.value.visible = false;
                            }
                        }, 200);
                    };

                    const selectSuggestion = (suggestion) => {
                        if (suggestionState.value.ingRef) {
                            suggestionState.value.ingRef.name = suggestion.name;
                            suggestionState.value.ingRef.isFlour = suggestion.isFlour;
                            suggestionState.value.ingRef.waterContent = suggestion.waterContent;
                        }
                        suggestionState.value.visible = false;
                        suggestionState.value.suggestions = [];
                        suggestionState.value.target = null;
                        suggestionState.value.ingRef = null;
                    };

                    const addMainDoughIngredient = () =>
                        mainDough.value.ingredients.push({
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            isFlour: false,
                            waterContent: 0,
                        });
                    const removeMainDoughIngredient = (index) => mainDough.value.ingredients.splice(index, 1);
                    const addMainDoughProcedureStep = () => mainDough.value.procedure.push('');
                    const removeMainDoughProcedureStep = (index) => mainDough.value.procedure.splice(index, 1);

                    const addOtherIngredient = () =>
                        currentVersion.value.ingredients.push({
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            isFlour: false,
                            waterContent: 0,
                        });
                    const removeOtherIngredient = (index) => currentVersion.value.ingredients.splice(index, 1);
                    const addOtherProcedureStep = () => currentVersion.value.procedure.push('');
                    const removeOtherProcedureStep = (index) => currentVersion.value.procedure.splice(index, 1);

                    const addProduct = () => {
                        currentVersion.value.products.push({
                            id: nextRecipeId++,
                            name: `产品${currentVersion.value.products.length + 1}`,
                            baseDoughWeight: 100,
                            mixIns: [],
                            fillings: [],
                            toppings: [],
                            procedure: [''],
                        });
                        nextTick(() => {
                            activeProductTab.value = currentVersion.value.products.length - 1;
                        });
                    };

                    const deleteProduct = (index) => {
                        const productName = currentVersion.value.products[index].name || `产品${index + 1}`;
                        if (!confirm(`确定要删除产品 "${productName}" 吗？`)) return;

                        currentVersion.value.products.splice(index, 1);

                        if (activeProductTab.value >= currentVersion.value.products.length) {
                            activeProductTab.value = Math.max(0, currentVersion.value.products.length - 1);
                        }
                    };

                    const addSubIngredient = (prodIndex, type) =>
                        currentVersion.value.products[prodIndex][type].push({
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            weightInGrams: null,
                            isFlour: false,
                            waterContent: 0,
                        });
                    const removeSubIngredient = (prodIndex, type, ingIndex) =>
                        currentVersion.value.products[prodIndex][type].splice(ingIndex, 1);
                    const addProductProcedureStep = (prodIndex) =>
                        currentVersion.value.products[prodIndex].procedure.push('');
                    const removeProductProcedureStep = (prodIndex, stepIndex) =>
                        currentVersion.value.products[prodIndex].procedure.splice(stepIndex, 1);

                    const toDecimal = (percentage) =>
                        percentage === null || percentage === undefined
                            ? 0
                            : parseFloat((parseFloat(percentage) / 100).toPrecision(12));
                    const toPercentage = (decimal) =>
                        decimal === null || decimal === undefined ? null : parseFloat((decimal * 100).toPrecision(12));

                    const updateSnapshot = () => {
                        savedRecipeSnapshots.value.clear();
                        for (const family of recipes.value) {
                            savedRecipeSnapshots.value.set(family.id, JSON.stringify(family));
                        }
                    };

                    // [G-Code-Note] 重构：loadRecipesFromJson (支持 Family 结构)
                    const loadRecipesFromJson = (jsonString) => {
                        try {
                            const importedData = JSON.parse(jsonString);
                            if (!Array.isArray(importedData)) throw new Error('JSON文件格式不正确，根节点应为数组。');

                            const preDoughMap = new Map();
                            importedData
                                .filter((r) => r.type !== 'MAIN')
                                .forEach((family) => {
                                    // 假设面种/馅料使用第一个版本的数据
                                    if (family.versions && family.versions.length > 0) {
                                        preDoughMap.set(family.name, family.versions[0]);
                                    }
                                });

                            const normalizedFamilies = importedData.map((family) => {
                                const newFamily = {
                                    id: nextRecipeId++,
                                    name: family.name,
                                    type: family.type,
                                    category: family.category || (family.type === 'MAIN' ? 'BREAD' : 'OTHER'),
                                    versions: [],
                                };

                                if (!family.versions || family.versions.length === 0) {
                                    // 如果导入的文件是旧格式（没有 versions 数组）
                                    // 则将其作为 V1 版本处理
                                    console.warn(
                                        `配方 "${family.name}" 是旧格式，将自动转换为 V1 版本。`,
                                    );
                                    const v1 = normalizeVersion(
                                        family, // 旧格式 recipe
                                        family.type,
                                        family.category,
                                        preDoughMap,
                                    );
                                    v1.notes = 'V1 - (从旧格式导入)';
                                    newFamily.versions = [v1];
                                } else {
                                    // 新格式，遍历版本
                                    newFamily.versions = family.versions.map((version) => {
                                        return normalizeVersion(
                                            version,
                                            family.type,
                                            family.category,
                                            preDoughMap,
                                        );
                                    });
                                }
                                return newFamily;
                            });

                            recipes.value = normalizedFamilies;

                            if (recipes.value.length > 0) {
                                nextTick(() => {
                                    selectFamily(recipes.value[0].id);
                                    activeCategory.value = recipes.value[0].type;
                                });
                            } else {
                                currentFamilyId.value = null;
                            }
                            alert(`成功加载 ${normalizedFamilies.length} 个配方族！`);
                            nextTick(updateSnapshot);
                        } catch (err) {
                            console.error('Load Error:', err);
                            alert(`加载失败：${err.message}`);
                        }
                    };

                    const triggerImport = () => fileInput.value.click();
                    const handleFileImport = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            fileHandle.value = null;
                            loadRecipesFromJson(e.target.result);
                            event.target.value = '';
                        };
                        reader.readAsText(file);
                    };

                    // [G-Code-Note] 重构：normalizeVersion (替换 normalizeRecipe)
                    // (versionData 是来自 JSON 的 *单个* 版本)
                    function normalizeVersion(versionData, familyType, familyCategory, preDoughMap) {
                        const baseVersion = {
                            id: nextVersionId++,
                            notes: versionData.notes || 'V?',
                            targetTemp: null,
                            lossRatio: null,
                            doughs: [],
                            products: [],
                            ingredients: [],
                            procedure: [],
                        };

                        const processImportedIngredient = (ing) => {
                            const predefinedMatch = allAvailableIngredients.value.find((p) => p.name === ing.name);
                            return {
                                id: nextIngredientId++,
                                name: ing.name,
                                ratio: toPercentage(ing.ratio),
                                isFlour: predefinedMatch ? predefinedMatch.isFlour : !!ing.isFlour,
                                waterContent: predefinedMatch ? predefinedMatch.waterContent : ing.waterContent || 0,
                            };
                        };

                        if (familyType === 'MAIN') {
                            const preDoughs = [];
                            const mainDoughIngredients = [];

                            (versionData.ingredients || []).forEach((ing) => {
                                if (preDoughMap.has(ing.name)) {
                                    const preDoughDef = preDoughMap.get(ing.name);
                                    if (preDoughDef) {
                                        const processedPreDoughIngredients = (preDoughDef.ingredients || []).map(
                                            processImportedIngredient,
                                        );
                                        preDoughs.push({
                                            id: nextRecipeId++,
                                            name: ing.name,
                                            type: 'PRE_DOUGH',
                                            flourRatioInMainDough: toPercentage(ing.flourRatio),
                                            ingredients: processedPreDoughIngredients,
                                            procedure: preDoughDef.procedure || [],
                                        });
                                    }
                                } else {
                                    mainDoughIngredients.push(processImportedIngredient(ing));
                                }
                            });

                            const mainDoughData = {
                                id: nextIngredientId++,
                                name: '主面团',
                                type: 'MAIN_DOUGH',
                                lossRatio: toPercentage(versionData.lossRatio),
                                divisionLoss: versionData.divisionLoss === undefined ? 2 : versionData.divisionLoss,
                                procedure:
                                    versionData.procedure && versionData.procedure.length > 0
                                        ? versionData.procedure
                                        : [''],
                                ingredients:
                                    mainDoughIngredients.length > 0
                                        ? mainDoughIngredients
                                        : [
                                              {
                                                  id: nextIngredientId++,
                                                  name: '',
                                                  ratio: null,
                                                  isFlour: false,
                                                  waterContent: 0,
                                              },
                                          ],
                            };

                            baseVersion.targetTemp = versionData.targetTemp || null;
                            baseVersion.doughs = [mainDoughData, ...preDoughs];
                            baseVersion.products =
                                versionData.products && versionData.products.length > 0
                                    ? versionData.products.map((p) => ({
                                          id: nextRecipeId++,
                                          name: p.name,
                                          baseDoughWeight: p.weight,
                                          mixIns: (p.mixIn || []).map((i) => ({
                                              id: nextIngredientId++,
                                              name: i.name,
                                              ratio: toPercentage(i.ratio),
                                              weightInGrams: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          })),
                                          fillings: (p.fillings || []).map((i) => ({
                                              id: nextIngredientId++,
                                              name: i.name,
                                              weightInGrams: i.weightInGrams,
                                              ratio: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          })),
                                          toppings: (p.toppings || []).map((i) => ({
                                              id: nextIngredientId++,
                                              name: i.name,
                                              weightInGrams: i.weightInGrams,
                                              ratio: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          })),
                                          procedure: p.procedure && p.procedure.length > 0 ? p.procedure : [''],
                                      }))
                                    : [
                                          {
                                              id: nextRecipeId++,
                                              name: '产品1',
                                              baseDoughWeight: 100,
                                              mixIns: [],
                                              fillings: [],
                                              toppings: [],
                                              procedure: [''],
                                          },
                                      ];
                        } else {
                            baseVersion.lossRatio = toPercentage(versionData.lossRatio) || null;
                            baseVersion.ingredients =
                                versionData.ingredients && versionData.ingredients.length > 0
                                    ? versionData.ingredients.map(processImportedIngredient)
                                    : [
                                          {
                                              id: nextIngredientId++,
                                              name: '',
                                              ratio: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          },
                                      ];
                            baseVersion.procedure =
                                versionData.procedure && versionData.procedure.length > 0
                                    ? versionData.procedure
                                    : [''];
                        }
                        return baseVersion;
                    }

                    // [G-Code-Note] 新增：exportVersion (将内部版本转换为 JSON 版本)
                    function exportVersion(version, familyType) {
                        const formatIngredient = (ing) => {
                            const result = {
                                name: ing.name,
                                ratio: toDecimal(ing.ratio),
                            };
                            if (ing.isFlour) {
                                result.isFlour = true;
                            }
                            if (ing.waterContent && ing.waterContent > 0) {
                                result.waterContent = ing.waterContent;
                            }
                            return result;
                        };

                        if (familyType === 'MAIN') {
                            const md = version.doughs.find((d) => d.type === 'MAIN_DOUGH');
                            const finalIngredients = [
                                ...version.doughs
                                    .filter((d) => d.type === 'PRE_DOUGH')
                                    .map((pd) => ({
                                        name: pd.name,
                                        flourRatio: toDecimal(pd.flourRatioInMainDough),
                                    })),
                                ...md.ingredients
                                    .filter((ing) => ing.name.trim() && ing.ratio !== null)
                                    .map(formatIngredient),
                            ];
                            return {
                                notes: version.notes,
                                targetTemp: version.targetTemp,
                                lossRatio: toDecimal(md.lossRatio),
                                divisionLoss: md.divisionLoss,
                                procedure: md.procedure.filter((p) => p.trim()),
                                ingredients: finalIngredients,
                                products: version.products.map((p) => ({
                                    name: p.name,
                                    weight: p.baseDoughWeight,
                                    procedure: p.procedure.filter((step) => step.trim()),
                                    mixIn: p.mixIns
                                        .filter((i) => i.name.trim() && i.ratio !== null)
                                        .map((i) => ({ name: i.name, ratio: toDecimal(i.ratio) })),
                                    fillings: p.fillings
                                        .filter((i) => i.name.trim() && i.weightInGrams !== null)
                                        .map((i) => ({ name: i.name, weightInGrams: i.weightInGrams })),
                                    toppings: p.toppings
                                        .filter((i) => i.name.trim() && i.weightInGrams !== null)
                                        .map((i) => ({ name: i.name, weightInGrams: i.weightInGrams })),
                                })),
                            };
                        } else {
                            // PRE_DOUGH 或 EXTRA
                            return {
                                notes: version.notes,
                                lossRatio: toDecimal(version.lossRatio),
                                ingredients: version.ingredients
                                    .filter((ing) => ing.name.trim() && ing.ratio !== null)
                                    .map(formatIngredient),
                                procedure: version.procedure.filter((p) => p.trim()),
                                products: [],
                            };
                        }
                    }

                    // [G-Code-Note] 重构：getRecipesAsJsonString (支持 Family 结构)
                    const getRecipesAsJsonString = () => {
                        if (recipes.value.length === 0) {
                            alert('请先添加至少一个配方');
                            return null;
                        }
                        try {
                            const processedFamilies = recipes.value.map((family) => {
                                if (!family.name || !family.name.trim())
                                    throw new Error(`列表中有未命名的配方族，请检查后再导出。`);

                                return {
                                    name: family.name,
                                    type: family.type,
                                    category: family.category,
                                    versions: family.versions.map((v) => exportVersion(v, family.type)),
                                };
                            });
                            return JSON.stringify(processedFamilies, null, 4);
                        } catch (err) {
                            alert(`处理数据失败: ${err.message}`);
                            return null;
                        }
                    };

                    const exportAllJson = () => {
                        const jsonString = getRecipesAsJsonString();
                        if (!jsonString) return;

                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `recipes_batch_export.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    };

                    const openFile = async () => {
                        try {
                            const [handle] = await window.showOpenFilePicker({
                                types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
                            });
                            const file = await handle.getFile();
                            const content = await file.text();
                            fileHandle.value = handle;
                            loadRecipesFromJson(content);
                        } catch (err) {
                            console.error('Failed to open file:', err);
                            if (err.name !== 'AbortError') {
                                alert(`打开文件失败: ${err.message}`);
                            }
                        }
                    };

                    const saveFile = async () => {
                        if (!fileHandle.value) {
                            alert('没有可保存的文件句柄。请先“打开文件”。');
                            return;
                        }
                        try {
                            const jsonString = getRecipesAsJsonString();
                            if (!jsonString) return;

                            const writable = await fileHandle.value.createWritable();
                            await writable.write(jsonString);
                            await writable.close();
                            alert('文件保存成功！');
                            updateSnapshot();
                        } catch (err) {
                            console.error('Failed to save file:', err);
                            alert(`保存文件失败: ${err.message}`);
                        }
                    };

                    const handleBeforeUnload = (event) => {
                        if (isDirty.value) {
                            event.preventDefault();
                            event.returnValue = '';
                        }
                    };

                    onMounted(() => {
                        window.addEventListener('beforeunload', handleBeforeUnload);
                    });
                    onUnmounted(() => {
                        window.removeEventListener('beforeunload', handleBeforeUnload);
                    });

                    return {
                        recipes,
                        currentFamilyId,
                        currentVersionIndex,
                        activeProductTab,
                        currentFamily,
                        currentVersion,
                        mainDough,
                        fileInput,
                        recipeNamePlaceholder,
                        recipeTypeDisplay,
                        isSelfMade,
                        recipeCategories,
                        filteredFamilies,
                        isAddPreDoughModalVisible,
                        categoryDisplay,
                        recipeContentTitle,
                        mainRecipeCategories,
                        availablePreDoughs,
                        availablePreDoughsForReferencing,
                        activeCategory,
                        mainContentRef,
                        productTabsRef,
                        versionTabsRef,
                        tabScrollState,
                        suggestionState,
                        suggestionBoxStyle,
                        processedPreDoughs,
                        isFSApiSupported,
                        fileHandle,
                        isFamilyDirty,
                        addFamily,
                        selectFamily,
                        deleteFamily,
                        addVersion,
                        deleteVersion,
                        triggerImport,
                        handleFileImport,
                        openAddPreDoughModal,
                        addPreDoughReference,
                        removePreDough,
                        handleIngredientInput,
                        handleIngredientBlur,
                        selectSuggestion,
                        scrollVersionTabs,
                        updateVersionTabScrollButtons,
                        scrollProductTabs,
                        updateProductTabScrollButtons,
                        addMainDoughIngredient,
                        removeMainDoughIngredient,
                        addMainDoughProcedureStep,
                        removeMainDoughProcedureStep,
                        addOtherIngredient,
                        removeOtherIngredient,
                        addOtherProcedureStep,
                        removeOtherProcedureStep,
                        addProduct,
                        deleteProduct,
                        addSubIngredient,
                        removeSubIngredient,
                        addProductProcedureStep,
                        removeProductProcedureStep,
                        exportAllJson,
                        openFile,
                        saveFile,
                    };
                },
            }).mount('#app');
        </script>
    </body>
</html>