<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>配方编辑器</title> <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <style>
            :root {
                /* 保持原始文件的颜色变量，不做修改 */
                --primary-color: #8c5a3b;
                --accent-color: #d4a373;
                --bg-color: #fdf8f2;
                --card-bg: #ffffff;
                --text-primary: #4a3f35;
                --text-secondary: #a98467;
                --danger-color: #e74c3c;
                --border-color: #f3e9e3;
                --sidebar-bg: #f7f4ef;
                
                /* 标签颜色 */
                --tag-flour-bg: #f0e6de; 
                --tag-flour-text: #8c5a3b;
                --tag-self-bg: #faedcd;
                --tag-self-text: #8c5a3b;
                /* 新增：水总量标签颜色 (参考截图的蓝色) */
                --tag-water-bg: #ecf5ff;
                --tag-water-text: #409eff;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans',
                    sans-serif;
                background-color: var(--bg-color);
                color: var(--text-primary);
                margin: 0;
                font-size: 16px;
            }

            /* --- 自定义滚动条样式 (匹配主题) --- */
            ::-webkit-scrollbar {
                width: 8px;  /* 纵向滚动条宽度 */
                height: 8px; /* 横向滚动条高度 */
            }
            
            ::-webkit-scrollbar-track {
                background: transparent; /* 轨道背景透明，显得更干净 */
            }
            
            ::-webkit-scrollbar-thumb {
                background-color: #e0d3c9; /* 默认滑块颜色：浅咖色，比背景稍深 */
                border-radius: 4px; /* 圆角 */
                border: 2px solid transparent; /* 透明边框 */
                background-clip: content-box; /* 让背景只在内容区显示，配合border实现“悬浮”感 */
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background-color: var(--accent-color); /* 鼠标悬停时变深，使用主题的点缀色 */
            }

            #app {
                display: flex;
                height: 100vh;
                overflow: hidden;
                max-width: 1024px;
                margin: 0 auto;
                box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            }

            /* --- Modal --- */
            .modal-overlay {
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex; justify-content: center; align-items: center; z-index: 1000;
            }
            .modal-content {
                background-color: white; border-radius: 20px; padding: 25px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                width: 90%; max-width: 400px; max-height: 80vh;
                display: flex; flex-direction: column;
            }
            .modal-header {
                font-size: 18px; font-weight: 600; color: var(--text-primary);
                margin-bottom: 20px; text-align: center;
            }
            .modal-body { overflow-y: auto; flex-grow: 1; }
            .modal-body .selection-item {
                padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer;
                transition: background-color 0.2s; text-align: center; font-weight: 500;
                border: 1px solid var(--border-color);
            }
            .modal-body .selection-item:hover { background-color: var(--sidebar-bg); border-color: var(--accent-color); }
            .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }

            /* --- 左侧栏 --- */
            .sidebar {
                width: 300px; flex-shrink: 0; background-color: var(--sidebar-bg);
                display: flex; flex-direction: column; border-right: 1px solid var(--border-color);
            }
            .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color); }
            .sidebar-header h1 { font-size: 24px; color: var(--primary-color); margin: 0; }
            .sidebar-header p { font-size: 13px; color: var(--text-secondary); margin-top: 5px; }

            .sidebar-tabs { display: flex; padding: 10px; gap: 5px; border-bottom: 1px solid var(--border-color); }
            .sidebar-tab {
                flex: 1; padding: 8px 5px; text-align: center; font-size: 14px;
                color: var(--text-secondary); border-radius: 10px; cursor: pointer;
                transition: background-color 0.2s, color 0.2s; position: relative;
            }
            .sidebar-tab.active { background-color: var(--primary-color); color: white; font-weight: 600; }
            .sidebar-tab .count-badge {
                position: absolute; top: -5px; right: -5px; background-color: var(--accent-color);
                color: white; font-size: 10px; border-radius: 50%; width: 18px; height: 18px;
                line-height: 18px; text-align: center;
            }

            .recipe-list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }
            .recipe-list-item {
                display: flex; justify-content: space-between; align-items: center; padding: 12px;
                border-radius: 10px; margin-bottom: 8px; cursor: pointer;
                transition: background-color 0.2s, box-shadow 0.2s;
            }
            .recipe-list-item:hover { background-color: var(--border-color); }
            .recipe-list-item.active {
                background-color: var(--primary-color); color: white;
                box-shadow: 0 4px 12px rgba(140, 90, 59, 0.2);
            }
            .recipe-list-item.active .recipe-info span { color: white !important; }
            .recipe-list-item.active .recipe-info .recipe-category-tag {
                background-color: white; color: var(--text-secondary) !important;
            }
            .recipe-info { display: flex; flex-direction: column; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .recipe-item-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
            .recipe-info strong { font-size: 15px; font-weight: 600; }
            .recipe-category-tag {
                font-size: 10px; font-weight: 500; background-color: var(--border-color);
                color: var(--text-secondary); padding: 2px 6px; border-radius: 5px;
                margin-left: 6px; vertical-align: middle;
            }

            .btn-delete-recipe {
                background: none; color: var(--text-secondary); border-radius: 50%;
                width: 24px; height: 24px; border: none; cursor: pointer; flex-shrink: 0;
                transition: all 0.2s; display: flex; align-items: center; justify-content: center;
                padding: 5px; visibility: hidden; opacity: 0;
            }
            .recipe-list-item:hover .btn-delete-recipe, .recipe-list-item.active .btn-delete-recipe { visibility: visible; opacity: 1; }
            .btn-delete-recipe:hover { background: var(--danger-color); color: white; }
            .btn-delete-recipe svg, .btn-delete-dough svg, .btn-remove svg { width: 100%; height: 100%; }
            .tab-delete-btn svg { width: 10px; height: 10px; }

            .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

            .card {
                background: var(--card-bg); padding: 20px; border-radius: 20px;
                margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); position: relative;
            }
            .card-title-wrapper { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 20px; }
            .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
            .form-item { margin-bottom: 20px; }
            .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .form-item-label { display: block; margin-bottom: 8px; font-size: 14px; color: #606266; }
            
            .input-field, .picker {
                width: 100%; height: 44px; line-height: 44px; padding: 0 12px;
                border: 1px solid var(--border-color); border-radius: 10px;
                font-size: 14px; background-color: #f8f9fa; box-sizing: border-box;
                color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
            }
            .input-field.ratio-input { width: 100px; text-align: center; flex-shrink: 0; flex-grow: 0; flex-basis: 100px; }
            .input-field:focus, .picker:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(140, 90, 59, 0.15); }

            .btn {
                display: inline-flex; justify-content: center; align-items: center;
                padding: 10px 15px; min-height: 44px; box-sizing: border-box;
                border-radius: 15px; font-size: 16px; font-weight: 500; text-align: center;
                cursor: pointer; transition: transform 0.2s, box-shadow 0.28s; border: none;
            }
            .btn:active { transform: scale(0.97); }
            .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
            .btn-primary { background-image: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%); color: white; box-shadow: 0 4px 15px rgba(140, 90, 59, 0.2); }
            .btn-secondary { background-color: #f3e9e3; color: var(--text-secondary); }
            .btn-full-width { width: 100%; }
            .btn-dashed { border: 1px dashed var(--primary-color); color: var(--primary-color); background: transparent; min-height: 46px; }
            .btn-remove {
                width: 40px; height: 40px; border: 1px dashed var(--border-color);
                border-radius: 10px; color: var(--danger-color); background: transparent;
                padding: 10px; min-height: auto; display: flex; align-items: center;
                justify-content: center; flex-shrink: 0;
            }

            .ingredient-header { display: flex; align-items: center; color: var(--text-secondary); font-size: 13px; margin-top: 15px; margin-bottom: 8px; gap: 10px; }
            .col-name { flex: 1; }
            .col-ratio { width: 100px; text-align: center; }
            .col-action { width: 40px; text-align: right; }
            .ingredient-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
            .ingredient-row > .input-with-tag-wrapper { flex: 1; }

            /* --- 智能标签容器样式 --- */
            .input-with-tag-wrapper {
                position: relative; 
                display: flex;
                align-items: center;
                width: 100%; 
            }
            
            .tags-container {
                position: absolute;
                right: 8px; 
                top: 50%;
                transform: translateY(-50%); 
                display: flex;
                gap: 4px;
                pointer-events: none; 
                z-index: 2; 
                height: auto;
            }
            
            /* 标签样式 */
            .ing-tag {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 6px; 
                font-weight: 600;
                line-height: 1;
            }
            .tag-flour { background-color: var(--tag-flour-bg); color: var(--tag-flour-text); }
            .tag-self { background-color: var(--tag-self-bg); color: var(--tag-self-text); }
            .tag-water { background-color: var(--tag-water-bg); color: var(--tag-water-text); } /* 新增水标签样式 */

            /* 动态 padding：给输入框留出位置显示标签 */
            .input-with-tag-wrapper.input-has-1-tag .input-field { padding-right: 55px !important; }
            .input-with-tag-wrapper.input-has-2-tags .input-field { padding-right: 100px !important; }

            .procedure-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
            .procedure-notes .notes-title { display: block; margin-bottom: 8px; font-size: 14px; color: #606266; }
            .sub-group { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
            .sub-group-title { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 15px; }

            /* Tabs Styles */
            .tabs-wrapper { position: relative; display: flex; align-items: center; margin-bottom: 20px; }
            .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab-item {
                padding: 10px 15px; cursor: pointer; color: var(--text-secondary); border-bottom: 3px solid transparent;
                transition: color 0.3s, border-color 0.3s; display: flex; align-items: center; gap: 8px; white-space: nowrap;
            }
            .tab-item.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
            .add-tab { font-weight: bold; color: var(--primary-color); }
            .tab-delete-btn {
                background-color: var(--border-color); border-radius: 50%; border: none; padding: 0; margin: 0;
                width: 18px; height: 18px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
                display: flex; align-items: center; justify-content: center; flex-shrink: 0; visibility: hidden; opacity: 0;
            }
            .tab-item:hover .tab-delete-btn, .tab-item.active .tab-delete-btn { visibility: visible; opacity: 1; }
            .tab-delete-btn:hover { background-color: var(--danger-color); color: white; }
            .tab-scroll-btn {
                position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255, 255, 255, 0.8);
                border: 1px solid var(--border-color); border-radius: 50%; width: 28px; height: 28px; z-index: 10;
                cursor: pointer; color: var(--text-secondary); font-size: 16px; display: flex; align-items: center;
                justify-content: center; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            }
            .tab-scroll-btn.left { left: -14px; } .tab-scroll-btn.right { right: -14px; }
            .tab-scroll-btn:hover { color: var(--primary-color); }

            .main-content { flex-grow: 1; overflow-y: auto; padding: 30px 20px; position: relative; }
            .editor-placeholder { display: flex; justify-content: center; align-items: center; height: 100%; text-align: center; color: var(--text-secondary); font-size: 18px; }
            .btn-delete-dough {
                position: absolute; top: 20px; right: 20px; background: none; border: none;
                color: var(--primary-color); cursor: pointer; width: 24px; height: 24px; opacity: 0.8; transition: opacity 0.2s;
            }
            .btn-delete-dough:hover { opacity: 1; }

            .suggestion-box {
                position: absolute; background-color: var(--card-bg); border: 1px solid var(--border-color);
                border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); z-index: 100;
                max-height: 200px; overflow-y: auto; list-style: none; margin: 0; padding: 5px; box-sizing: border-box;
            }
            .suggestion-item { padding: 8px 12px; font-size: 14px; cursor: pointer; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
            .suggestion-item:hover { background-color: var(--sidebar-bg); }
            .suggestion-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500; margin-left: 8px; }
            .suggestion-action { color: var(--primary-color); font-weight: 600; }
        </style>
    </head>

    <body>
        <svg style="display: none">
            <symbol id="icon-trash" viewBox="0 0 72 72">
                <path style="fill: currentColor" d="M31.4,5.9c-1.3,0-2.6,0.5-3.6,1.4c-0.9,0.9-1.4,2.3-1.4,3.6v2.5H11.5v5H14v39.8c0,4.1,3.4,7.5,7.5,7.5h29.8 c4.1,0,7.5-3.4,7.5-7.5V18.3h2.5v-5H46.3v-2.5c0-1.3-0.5-2.6-1.4-3.6s-2.3-1.4-3.6-1.4H31.4z M31.4,10.9h9.9v2.5h-9.9V10.9z M18.9,18.3h34.8v39.8c0,1.4-1.1,2.5-2.5,2.5H21.4c-1.4,0-2.5-1.1-2.5-2.5V18.3z M23.9,25.8v27.3h5V25.8H23.9z M33.9,25.8v27.3h5 V25.8H33.9z M43.8,25.8v27.3h5V25.8H43.8z" />
            </symbol>
            <symbol id="icon-close" viewBox="0 0 16 16">
                <line fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="14" y1="2" x2="2" y2="14" />
                <line fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="2" y1="2" x2="14" y2="14" />
            </symbol>
        </svg>

        <div id="app">
            <aside class="sidebar">
                <header class="sidebar-header">
                    <h1>配方工作区</h1>
                    <p>打开、编辑并保存您的配方</p>
                </header>

                <div class="sidebar-tabs">
                    <div class="sidebar-tab" :class="{active: activeCategory === 'MAIN'}" @click="activeCategory = 'MAIN'">
                        产品配方
                        <span v-if="recipeCategories.main.length > 0" class="count-badge">{{ recipeCategories.main.length }}</span>
                    </div>
                    <div class="sidebar-tab" :class="{active: activeCategory === 'PRE_DOUGH'}" @click="activeCategory = 'PRE_DOUGH'">
                        面种
                        <span v-if="recipeCategories.preDough.length > 0" class="count-badge">{{ recipeCategories.preDough.length }}</span>
                    </div>
                    <div class="sidebar-tab" :class="{active: activeCategory === 'EXTRA'}" @click="activeCategory = 'EXTRA'">
                        馅料
                        <span v-if="recipeCategories.extra.length > 0" class="count-badge">{{ recipeCategories.extra.length }}</span>
                    </div>
                </div>

                <div class="recipe-list-container">
                    <div v-for="family in filteredFamilies" :key="family.id" class="recipe-list-item" :class="{ active: currentFamily && currentFamily.id === family.id }" @click="selectFamily(family.id)">
                        <div class="recipe-info">
                            <strong>
                                {{ family.name || `未命名配方` }}
                                <span v-if="family.type === 'MAIN'" class="recipe-category-tag">{{ categoryDisplay(family.category) }}</span>
                                <span v-if="isFamilyDirty(family)" style="color: var(--danger-color); margin-left: 4px">*</span>
                            </strong>
                        </div>
                        <div class="recipe-item-controls">
                            <button class="btn-delete-recipe" @click.stop="deleteFamily(family.id)">
                                <svg><use href="#icon-trash"></use></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <footer class="sidebar-footer">
                    <button class="btn btn-dashed btn-full-width" @click="addFamily()">+ 新增配方</button>
                    <button class="btn btn-secondary btn-full-width" @click="openFile" v-if="isFSApiSupported">打开文件</button>
                    <button class="btn btn-primary btn-full-width" @click="saveFile" v-if="isFSApiSupported" :disabled="!fileHandle" style="grid-column: 1 / -1">保存文件</button>
                    <template v-if="!isFSApiSupported">
                        <button class="btn btn-secondary btn-full-width" @click="triggerImport">导入JSON</button>
                        <button class="btn btn-primary btn-full-width" @click="exportAllJson" :disabled="recipes.length === 0" style="grid-column: 1 / -1">导出JSON</button>
                    </template>
                    <input type="file" ref="fileInput" @change="handleFileImport" accept=".json" style="display: none" />
                </footer>
            </aside>
            <main class="main-content" ref="mainContentRef">
                <div v-if="currentFamily && currentVersion" class="editor-content">
                    <div class="card">
                        <div class="form-grid">
                            <div class="form-item" style="margin-bottom: 0">
                                <label class="form-item-label">配方名称 (配方族)</label>
                                <input
                                    class="input-field"
                                    v-model="currentFamily.name"
                                    :placeholder="recipeNamePlaceholder"
                                />
                            </div>
                            <div class="form-item" style="margin-bottom: 0">
                                <label class="form-item-label">配方类型</label>
                                <input
                                    class="input-field"
                                    :value="recipeTypeDisplay(currentFamily.type)"
                                    readonly
                                    disabled
                                />
                            </div>
                        </div>
                        <div v-if="currentFamily.type === 'MAIN'" class="form-item" style="margin-top: 20px">
                            <label class="form-item-label">配方品类</label>
                            <select class="picker" v-model="currentFamily.category">
                                <option v-for="cat in mainRecipeCategories" :key="cat.value" :value="cat.value">
                                    {{ cat.text }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title-wrapper" style="margin-bottom: 10px">
                            <span class="card-title">版本管理</span>
                        </div>
                        <div class="tabs-wrapper">
                            <button
                                v-if="tabScrollState.version.showLeft"
                                class="tab-scroll-btn left"
                                @click="scrollVersionTabs(-150)"
                            >
                                &lt;
                            </button>
                            <div class="tabs" ref="versionTabsRef" @scroll="updateVersionTabScrollButtons">
                                <div
                                    v-for="(version, index) in currentFamily.versions"
                                    :key="version.id"
                                    class="tab-item"
                                    :class="{ active: currentVersionIndex === index }"
                                    @click="currentVersionIndex = index"
                                >
                                    <span>{{ version.notes || `版本 ${index + 1}` }}</span>
                                    <button class="tab-delete-btn" @click.stop="deleteVersion(index)">
                                        <svg><use href="#icon-close"></use></svg>
                                    </button>
                                </div>
                                <div class="tab-item add-tab" @click="addVersion">+</div>
                            </div>
                            <button
                                v-if="tabScrollState.version.showRight"
                                class="tab-scroll-btn right"
                                @click="scrollVersionTabs(150)"
                            >
                                &gt;
                            </button>
                        </div>
                        <div class="form-item" style="margin-top: 20px; margin-bottom: 0">
                            <label class="form-item-label">版本备注 (例如: V1 - 冬季配方)</label>
                            <input class="input-field" v-model="currentVersion.notes" placeholder="输入备注" />
                        </div>
                    </div>

                    <div v-if="currentFamily.type === 'MAIN'">
                        <template v-if="currentFamily.category === 'BREAD'">
                            <div v-for="(dough, doughIndex) in processedPreDoughs" :key="dough.id" class="card">
                                <button class="btn-delete-dough" @click="removePreDough(doughIndex)">
                                    <svg><use href="#icon-close"></use></svg>
                                </button>
                                <div class="card-title-wrapper">
                                    <span class="card-title">{{ dough.name }}</span>
                                </div>
                                <div class="form-item">
                                    <label class="form-item-label">面种中面粉占总面粉的百分比 (%)</label>
                                    <input
                                        class="input-field"
                                        type="number"
                                        :value="dough.flourRatioInMainDough"
                                        @input="updatePreDoughRatio(dough.id, $event.target.value)"
                                        placeholder="例如: 20"
                                    />
                                </div>

                                <div class="ingredient-header" style="opacity: 0.7; margin-top: 0">
                                    <span class="col-name">原料 (换算后，基于主面团总面粉)</span>
                                    <span class="col-ratio">比例 %</span>
                                    <span class="col-action"></span>
                                </div>

                                <div
                                    v-for="ing in dough.calculatedIngredients"
                                    :key="ing.id"
                                    class="ingredient-row"
                                    style="opacity: 0.7"
                                >
                                    <div class="input-with-tag-wrapper" :class="getWrapperClass(ing)">
                                        <input class="input-field" :value="ing.name" readonly />
                                        <div class="tags-container">
                                            <span v-if="ing.isFlour" class="ing-tag tag-flour">面粉</span>
                                        </div>
                                    </div>
                                    <input
                                        class="input-field ratio-input"
                                        type="number"
                                        :value="ing.calculatedRatio"
                                        readonly
                                    />
                                    <div style="width: 40px; flex-shrink: 0"></div>
                                </div>
                            </div>
                            <button
                                class="btn btn-dashed btn-full-width"
                                style="margin-bottom: 20px"
                                @click="openAddPreDoughModal"
                            >
                                + 添加面种引用
                            </button>
                        </template>

                        <div class="card">
                            <div class="card-title-wrapper">
                                <span class="card-title">{{ recipeContentTitle }}</span>
                            </div>
                            <div v-if="currentFamily.category === 'BREAD'" class="form-item">
                                <label class="form-item-label">面团出缸温度 (°C)</label>
                                <input
                                    class="input-field"
                                    type="number"
                                    v-model.number="currentVersion.targetTemp"
                                    placeholder="例如: 26"
                                />
                            </div>
                            <div class="form-item">
                                <label class="form-item-label">工艺损耗率 (%)</label
                                ><input
                                    class="input-field"
                                    type="number"
                                    v-model.number="mainDough.lossRatio"
                                    placeholder="例如: 1"
                                />
                            </div>
                            <div class="form-item">
                                <label class="form-item-label">分割损耗 (g)</label
                                ><input
                                    class="input-field"
                                    type="number"
                                    v-model.number="mainDough.divisionLoss"
                                    placeholder="例如: 2"
                                />
                            </div>
                            <div class="ingredient-header">
                                <span class="col-name">原料名称</span>
                                <span class="col-ratio">比例 %</span>
                                <span class="col-action"></span>
                            </div>
                            <div v-for="ing in sortedMainDoughIngredients" :key="ing.id" class="ingredient-row">
                                <div class="input-with-tag-wrapper" :class="getWrapperClass(ing)">
                                    <input
                                        class="input-field"
                                        v-model="ing.name"
                                        placeholder="输入原料名称"
                                        @focus="handleIngredientInput(ing, $event)"
                                        @input="handleIngredientInput(ing, $event)"
                                        @blur="handleIngredientBlur(ing)"
                                    />
                                    <div class="tags-container">
                                        <span v-if="ing.isFlour" class="ing-tag tag-flour">面粉</span>
                                        <span v-if="ing.name === '水' && currentFamily.category === 'BREAD'" class="ing-tag tag-water">
                                            总量: {{ totalWaterRatio }}%
                                        </span>
                                    </div>
                                </div>
                                <input
                                    class="input-field ratio-input"
                                    type="number"
                                    v-model.lazy.number="ing.ratio"
                                    placeholder="%"
                                />
                                <button class="btn btn-remove" @click="removeMainDoughIngredient(ing.id)">
                                    <svg><use href="#icon-trash"></use></svg>
                                </button>
                            </div>
                            <button class="btn btn-dashed btn-full-width" @click="addMainDoughIngredient">
                                + 添加原料
                            </button>
                            <div class="procedure-notes sub-group">
                                <span class="notes-title">制作要点:</span>
                                <div v-for="(step, index) in mainDough.procedure" :key="index" class="procedure-item">
                                    <input
                                        class="input-field"
                                        v-model="mainDough.procedure[index]"
                                        placeholder="输入制作步骤"
                                    />
                                    <button class="btn btn-remove" @click="removeMainDoughProcedureStep(index)">
                                        <svg><use href="#icon-trash"></use></svg>
                                    </button>
                                </div>
                                <button class="btn btn-dashed btn-full-width" @click="addMainDoughProcedureStep">
                                    + 添加要点
                                </button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-title-wrapper"><span class="card-title">产品列表</span></div>
                            <div class="tabs-wrapper">
                                <button
                                    v-if="tabScrollState.product.showLeft"
                                    class="tab-scroll-btn left"
                                    @click="scrollProductTabs(-150)"
                                >
                                    &lt;
                                </button>
                                <div class="tabs" ref="productTabsRef" @scroll="updateProductTabScrollButtons">
                                    <div
                                        v-for="(product, index) in productsWithSortedMixIns"
                                        :key="product.id"
                                        class="tab-item"
                                        :class="{ active: activeProductTab === index }"
                                        @click="activeProductTab = index"
                                    >
                                        <span>{{ product.name || `产品${index + 1}` }}</span>
                                        <button class="tab-delete-btn" @click.stop="deleteProduct(index)">
                                            <svg><use href="#icon-close"></use></svg>
                                        </button>
                                    </div>
                                    <div class="tab-item add-tab" @click="addProduct">+</div>
                                </div>
                                <button
                                    v-if="tabScrollState.product.showRight"
                                    class="tab-scroll-btn right"
                                    @click="scrollProductTabs(150)"
                                >
                                    &gt;
                                </button>
                            </div>

                            <div v-if="currentVersion.products.length > 0">
                                <div
                                    v-for="(product, prodIndex) in productsWithSortedMixIns"
                                    v-show="activeProductTab === prodIndex"
                                    :key="product.id"
                                >
                                    <div class="form-item">
                                        <label class="form-item-label">产品名称</label
                                        >
                                        <input
                                            class="input-field"
                                            v-model="currentVersion.products[prodIndex].name"
                                            :placeholder="`产品${prodIndex + 1}`"
                                        />
                                    </div>
                                    <div class="form-item">
                                        <label class="form-item-label">基础原料克重 (g)</label
                                        >
                                        <input
                                            class="input-field"
                                            type="number"
                                            v-model.number="currentVersion.products[prodIndex].baseDoughWeight"
                                            placeholder="例如: 100"
                                        />
                                    </div>
                                    <div class="sub-group">
                                        <h4 class="sub-group-title">辅料 (配方百分比)</h4>
                                        <div
                                            v-for="ing in product.sortedMixIns"
                                            :key="ing.id"
                                            class="ingredient-row"
                                        >
                                            <div class="input-with-tag-wrapper" :class="getWrapperClass(ing)">
                                                <input
                                                    class="input-field"
                                                    v-model="ing.name"
                                                    placeholder="输入辅料名称"
                                                    @focus="handleIngredientInput(ing, $event)"
                                                    @input="handleIngredientInput(ing, $event)"
                                                    @blur="handleIngredientBlur(ing)"
                                                />
                                                <div class="tags-container">
                                                    <span v-if="ing.isFlour" class="ing-tag tag-flour">面粉</span>
                                                    <span v-if="isSelfMade(ing.name)" class="ing-tag tag-self">自制</span>
                                                </div>
                                            </div>
                                            <input
                                                class="input-field ratio-input"
                                                type="number"
                                                v-model.lazy.number="ing.ratio"
                                                placeholder="%"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeSubIngredient(product.id, 'mixIns', ing.id)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addSubIngredient(prodIndex, 'mixIns')"
                                        >
                                            + 添加辅料
                                        </button>
                                    </div>
                                    <div class="sub-group">
                                        <h4 class="sub-group-title">馅料 (克/个)</h4>
                                        <div
                                            v-for="ing in product.sortedFillings"
                                            :key="ing.id"
                                            class="ingredient-row"
                                        >
                                            <div class="input-with-tag-wrapper" :class="getWrapperClass(ing)">
                                                <input
                                                    class="input-field"
                                                    v-model="ing.name"
                                                    placeholder="输入馅料名称"
                                                    @focus="handleIngredientInput(ing, $event)"
                                                    @input="handleIngredientInput(ing, $event)"
                                                    @blur="handleIngredientBlur(ing)"
                                                />
                                                <div class="tags-container">
                                                    <span v-if="ing.isFlour" class="ing-tag tag-flour">面粉</span>
                                                    <span v-if="isSelfMade(ing.name)" class="ing-tag tag-self">自制</span>
                                                </div>
                                            </div>
                                            <input
                                                class="input-field ratio-input"
                                                type="number"
                                                v-model.lazy.number="ing.weightInGrams"
                                                placeholder="g/个"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeSubIngredient(product.id, 'fillings', ing.id)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addSubIngredient(prodIndex, 'fillings')"
                                        >
                                            + 添加馅料
                                        </button>
                                    </div>
                                    <div class="sub-group">
                                        <h4 class="sub-group-title">表面装饰 (克/个)</h4>
                                        <div
                                            v-for="ing in product.sortedToppings"
                                            :key="ing.id"
                                            class="ingredient-row"
                                        >
                                            <div class="input-with-tag-wrapper" :class="getWrapperClass(ing)">
                                                <input
                                                    class="input-field"
                                                    v-model="ing.name"
                                                    placeholder="输入装饰名称"
                                                    @focus="handleIngredientInput(ing, $event)"
                                                    @input="handleIngredientInput(ing, $event)"
                                                    @blur="handleIngredientBlur(ing)"
                                                />
                                                <div class="tags-container">
                                                    <span v-if="ing.isFlour" class="ing-tag tag-flour">面粉</span>
                                                    <span v-if="isSelfMade(ing.name)" class="ing-tag tag-self">自制</span>
                                                </div>
                                            </div>
                                            <input
                                                class="input-field ratio-input"
                                                type="number"
                                                v-model.lazy.number="ing.weightInGrams"
                                                placeholder="g/个"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeSubIngredient(product.id, 'toppings', ing.id)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addSubIngredient(prodIndex, 'toppings')"
                                        >
                                            + 添加表面装饰
                                        </button>
                                    </div>
                                    <div class="procedure-notes sub-group">
                                        <span class="notes-title">产品制作要点:</span>
                                        <div
                                            v-for="(step, stepIndex) in product.procedure"
                                            :key="stepIndex"
                                            class="procedure-item"
                                        >
                                            <input
                                                class="input-field"
                                                v-model="product.procedure[stepIndex]"
                                                placeholder="输入制作步骤"
                                            />
                                            <button
                                                class="btn btn-remove"
                                                @click="removeProductProcedureStep(prodIndex, stepIndex)"
                                            >
                                                <svg><use href="#icon-trash"></use></svg>
                                            </button>
                                        </div>
                                        <button
                                            class="btn btn-dashed btn-full-width"
                                            @click="addProductProcedureStep(prodIndex)"
                                        >
                                            + 添加要点
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="editor-placeholder">
                                <p>暂无产品<br />点击上方的 "+" 添加一个新产品</p>
                            </div>
                        </div>
                    </div>

                    <div v-else>
                        <div class="card">
                            <div class="card-title-wrapper"><span class="card-title">原料列表</span></div>
                            <div class="form-item">
                                <label class="form-item-label">工艺损耗率 (%)</label>
                                <input
                                    class="input-field"
                                    type="number"
                                    v-model.number="currentVersion.lossRatio"
                                    placeholder="例如: 1"
                                />
                            </div>
                            <div class="ingredient-header">
                                <span class="col-name">原料名称</span>
                                <span class="col-ratio">比例 %</span>
                                <span class="col-action"></span>
                            </div>
                            <div
                                v-for="ing in sortedOtherIngredients"
                                :key="ing.id"
                                class="ingredient-row"
                            >
                                <div class="input-with-tag-wrapper" :class="getWrapperClass(ing)">
                                    <input
                                        class="input-field"
                                        v-model="ing.name"
                                        placeholder="输入原料名称"
                                        @focus="handleIngredientInput(ing, $event)"
                                        @input="handleIngredientInput(ing, $event)"
                                        @blur="handleIngredientBlur(ing)"
                                    />
                                    <div class="tags-container">
                                        <span v-if="ing.isFlour" class="ing-tag tag-flour">面粉</span>
                                    </div>
                                </div>
                                <input
                                    class="input-field ratio-input"
                                    type="number"
                                    v-model.lazy.number="ing.ratio"
                                    placeholder="%"
                                />
                                <button class="btn btn-remove" @click="removeOtherIngredient(ing.id)">
                                    <svg><use href="#icon-trash"></use></svg>
                                </button>
                            </div>
                            <button class="btn btn-dashed btn-full-width" @click="addOtherIngredient">
                                + 添加原料
                            </button>
                            <div class="procedure-notes sub-group">
                                <span class="notes-title">制作要点:</span>
                                <div
                                    v-for="(step, index) in currentVersion.procedure"
                                    :key="index"
                                    class="procedure-item"
                                >
                                    <input
                                        class="input-field"
                                        v-model="currentVersion.procedure[index]"
                                        placeholder="输入制作步骤"
                                    />
                                    <button class="btn btn-remove" @click="removeOtherProcedureStep(index)">
                                        <svg><use href="#icon-trash"></use></svg>
                                    </button>
                                </div>
                                <button class="btn btn-dashed btn-full-width" @click="addOtherProcedureStep">
                                    + 添加要点
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="editor-placeholder">
                    <p>← 从左侧选择一个配方进行编辑<br />或新增一个配方</p>
                </div>

                <ul v-if="suggestionState.visible" class="suggestion-box" :style="suggestionBoxStyle">
                    <li
                        v-for="sugg in suggestionState.suggestions"
                        :key="sugg.key"
                        class="suggestion-item"
                        @mousedown="selectSuggestion(sugg)"
                    >
                        <template v-if="sugg.type === 'EXISTING'">
                            <span>{{ sugg.name }}</span>
                            <span v-if="sugg.isFlour" class="suggestion-tag tag-flour">面粉</span>
                            <span v-if="sugg.selfMade" class="suggestion-tag tag-self">自制</span>
                        </template>
                        <template v-else-if="sugg.type === 'NEW_NORMAL'">
                            <span class="suggestion-action">+ 新建原料: {{ sugg.name }}</span>
                        </template>
                        <template v-else-if="sugg.type === 'NEW_FLOUR'">
                            <span class="suggestion-action">+ 新建面粉: {{ sugg.name }}</span>
                        </template>
                    </li>
                </ul>
            </main>

            <div v-if="isAddPreDoughModalVisible" class="modal-overlay" @click="isAddPreDoughModalVisible = false">
                <div class="modal-content" @click.stop>
                    <div class="modal-header">选择要引用的面种</div>
                    <div class="modal-body">
                        <div
                            v-for="dough in availablePreDoughsForReferencing"
                            :key="dough.id"
                            class="recipe-list-item"
                            @click="addPreDoughReference(dough)"
                        >
                            <div class="recipe-info"><strong>{{ dough.name }}</strong></div>
                        </div>
                        <div
                            v-if="availablePreDoughsForReferencing.length === 0"
                            style="text-align: center; color: var(--text-secondary)"
                        >
                            暂无可引用的面种
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @click="isAddPreDoughModalVisible = false">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const { createApp, ref, computed, watch, nextTick, onMounted, onUnmounted } = Vue;

            createApp({
                setup() {
                    let nextRecipeId = 1;
                    let nextIngredientId = 1000;
                    let nextVersionId = 10000; 

                    const recipes = ref([]); 
                    const currentFamilyId = ref(null); 
                    const currentVersionIndex = ref(0); 
                    const activeProductTab = ref(0);
                    const fileInput = ref(null);
                    const isAddPreDoughModalVisible = ref(false);
                    const activeCategory = ref('MAIN');
                    const mainContentRef = ref(null);
                    const productTabsRef = ref(null);
                    const versionTabsRef = ref(null); 
                    const fileHandle = ref(null);

                    const savedRecipeSnapshots = ref(new Map());
                    const isFSApiSupported = computed(() => 'showOpenFilePicker' in window);

                    // 全局原料库
                    const globalIngredientLibrary = ref(new Map());

                    // 初始化原料库
                    const initIngredientLibrary = () => {
                        const defaults = [
                            { name: '面包粉', isFlour: true, waterContent: 0 },
                            { name: '高筋粉', isFlour: true, waterContent: 0 },
                            { name: '中筋粉', isFlour: true, waterContent: 0 },
                            { name: '全麦粉', isFlour: true, waterContent: 0 },
                            { name: '裸麦粉', isFlour: true, waterContent: 0 },
                            { name: '黑麦粉', isFlour: true, waterContent: 0 },
                            { name: 'T45', isFlour: true, waterContent: 0 },
                            { name: 'T55', isFlour: true, waterContent: 0 },
                            { name: 'T65', isFlour: true, waterContent: 0 },
                            { name: 'T80', isFlour: true, waterContent: 0 },
                            { name: 'T110', isFlour: true, waterContent: 0 },
                            { name: 'T150', isFlour: true, waterContent: 0 },
                            { name: 'T170', isFlour: true, waterContent: 0 },
                            { name: '水', isFlour: false, waterContent: 1 },
                            { name: '牛奶', isFlour: false, waterContent: 0.87 },
                            { name: '淡奶油', isFlour: false, waterContent: 0.6 },
                            { name: '蜂蜜', isFlour: false, waterContent: 0.17 },
                            { name: '炼乳', isFlour: false, waterContent: 0.27 },
                            { name: '鸡蛋', isFlour: false, waterContent: 0.75 },
                            { name: '全蛋', isFlour: false, waterContent: 0.75 },
                            { name: '蛋黄', isFlour: false, waterContent: 0.5 },
                            { name: '蛋清', isFlour: false, waterContent: 0.88 },
                            { name: '蛋白', isFlour: false, waterContent: 0.88 },
                            { name: '白砂糖', isFlour: false, waterContent: 0 },
                            { name: '盐', isFlour: false, waterContent: 0 },
                            { name: '即发干酵母', isFlour: false, waterContent: 0 },
                            { name: '鲜酵母', isFlour: false, waterContent: 0 },
                            { name: '黄油', isFlour: false, waterContent: 0 },
                            { name: '奶粉', isFlour: false, waterContent: 0 },
                            { name: '麦芽精', isFlour: false, waterContent: 0 },
                        ];
                        defaults.forEach(ing => {
                            globalIngredientLibrary.value.set(ing.name, ing);
                        });
                    };
                    initIngredientLibrary();

                    // 动态计算标签Wrapper的样式 (用于第一部分CSS的padding控制)
                    // 修改：增加对水标签的判断，赋予更宽的padding
                    const getWrapperClass = (ing) => {
                        let count = 0;
                        if (ing.isFlour) count++;
                        if (isSelfMade(ing.name)) count++;
                        
                        const hasWaterTag = ing.name === '水' && currentFamily.value?.category === 'BREAD';
                        
                        if (hasWaterTag) {
                            // 水标签比较宽 ("总量: 84%"), 直接给予2个标签宽度的空间
                            return 'input-has-2-tags';
                        }

                        if (count === 1) return 'input-has-1-tag';
                        if (count === 2) return 'input-has-2-tags';
                        return '';
                    };

                    const isFamilyDirty = (family) => {
                        if (!family) return false;
                        const savedSnapshot = savedRecipeSnapshots.value.get(family.id);
                        if (!savedSnapshot) {
                            return true; // 新增的
                        }
                        return JSON.stringify(family) !== savedSnapshot;
                    };

                    const isDirty = computed(() => {
                        if (recipes.value.length !== savedRecipeSnapshots.value.size) {
                            return true;
                        }
                        return recipes.value.some((family) => isFamilyDirty(family));
                    });

                    const tabScrollState = ref({
                        version: { showLeft: false, showRight: false },
                        product: { showLeft: false, showRight: false },
                    });

                    const categoryDisplayMap = {
                        BREAD: '面包',
                        PASTRY: '西点',
                        DESSERT: '甜品',
                        DRINK: '饮品',
                        OTHER: '其他',
                    };
                    const categoryDisplay = (category) => categoryDisplayMap[category] || '未知品类';

                    const mainRecipeCategories = ref(
                        Object.entries(categoryDisplayMap)
                            .filter(([key]) => key !== 'OTHER')
                            .map(([value, text]) => ({ value, text })),
                    );

                    const selfMadeRecipeNames = computed(
                        () => new Set(recipes.value.filter((r) => r.type !== 'MAIN').map((r) => r.name)),
                    );
                    const isSelfMade = (name) => selfMadeRecipeNames.value.has(name);

                    const suggestionState = ref({
                        visible: false,
                        suggestions: [],
                        target: null,
                        ingRef: null,
                    });
                    const suggestionBoxStyle = ref({});

                    watch(
                        () => suggestionState.value.target,
                        (newTarget) => {
                            if (!newTarget || !mainContentRef.value) {
                                suggestionState.value.visible = false;
                                return;
                            }
                            const targetRect = newTarget.getBoundingClientRect();
                            const parentRect = mainContentRef.value.getBoundingClientRect();

                            suggestionBoxStyle.value = {
                                top: `${targetRect.bottom - parentRect.top + mainContentRef.value.scrollTop}px`,
                                left: `${targetRect.left - parentRect.left}px`,
                                width: `${targetRect.width}px`,
                            };
                        },
                    );

                    const currentFamilyIndex = computed(() =>
                        recipes.value.findIndex((r) => r.id === currentFamilyId.value),
                    );
                    const currentFamily = computed(() =>
                        currentFamilyIndex.value > -1 ? recipes.value[currentFamilyIndex.value] : null,
                    );
                    const currentVersion = computed(() =>
                        currentFamily.value
                            ? currentFamily.value.versions[currentVersionIndex.value]
                            : null,
                    );

                    const showFlourCheckbox = computed(() => {
                        if (!currentFamily.value) return false;
                        if (currentFamily.value.type === 'PRE_DOUGH') return true;
                        if (currentFamily.value.type === 'MAIN' && currentFamily.value.category === 'BREAD') return true;
                        return false;
                    });

                    const mainDough = computed(() =>
                        currentFamily.value?.type === 'MAIN' && currentVersion.value
                            ? currentVersion.value.doughs.find((d) => d.type === 'MAIN_DOUGH')
                            : null,
                    );

                    const processedPreDoughs = computed(() => {
                        if (
                            !currentFamily.value ||
                            currentFamily.value.type !== 'MAIN' ||
                            !currentVersion.value
                        ) {
                            return [];
                        }
                        const preDoughs = currentVersion.value.doughs.filter((d) => d.type === 'PRE_DOUGH');

                        return preDoughs.map((dough) => {
                            const totalFlourRatioInPreDough = dough.ingredients
                                .filter((ing) => ing.isFlour) 
                                .reduce((sum, ing) => sum + (ing.ratio || 0), 0);

                            if (totalFlourRatioInPreDough === 0) {
                                return {
                                    ...dough,
                                    calculatedIngredients: dough.ingredients.map((ing) => ({
                                        ...ing,
                                        calculatedRatio: ing.ratio, 
                                    })),
                                };
                            }

                            const flourRatioInMainDough = dough.flourRatioInMainDough || 0;

                            const calculatedIngredients = dough.ingredients.map((ing) => {
                                const calculatedRatio =
                                    ((ing.ratio || 0) / totalFlourRatioInPreDough) * flourRatioInMainDough;

                                return {
                                    ...ing,
                                    calculatedRatio: parseFloat(calculatedRatio.toFixed(3)),
                                };
                            });

                            return {
                                ...dough,
                                calculatedIngredients,
                            };
                        });
                    });

                    // 新增：计算总水量（主面团含水原料 + 面种含水原料）
                    const totalWaterRatio = computed(() => {
                        if (!currentFamily.value || currentFamily.value.type !== 'MAIN' || !currentVersion.value) return 0;
                        
                        let totalWater = 0;

                        // 1. 计算主面团中含水原料的水量
                        if (mainDough.value) {
                            mainDough.value.ingredients.forEach(ing => {
                                const content = ing.waterContent || 0;
                                const ratio = parseFloat(ing.ratio) || 0;
                                totalWater += ratio * content;
                            });
                        }

                        // 2. 计算所有引用面种中的水量
                        // 使用 processedPreDoughs，因为里面的 calculatedIngredients 已经是折算到主面团体系下的比例了
                        processedPreDoughs.value.forEach(pd => {
                            pd.calculatedIngredients.forEach(ing => {
                                const content = ing.waterContent || 0;
                                const ratio = parseFloat(ing.calculatedRatio) || 0;
                                totalWater += ratio * content;
                            });
                        });

                        return parseFloat(totalWater.toFixed(1));
                    });

                    const updatePreDoughRatio = (doughId, rawValue) => {
                        const originalDough = currentVersion.value.doughs.find((d) => d.id === doughId);
                        if (originalDough) {
                            const parsedValue = parseFloat(rawValue);
                            originalDough.flourRatioInMainDough = isNaN(parsedValue) ? null : parsedValue;
                        }
                    };

                    const recipeContentTitle = computed(() => {
                        if (!currentFamily.value) return '';
                        if (currentFamily.value.category === 'BREAD') return '主面团';
                        return '配方内容';
                    });

                    const recipeCategories = computed(() => ({
                        main: recipes.value.filter((r) => r.type === 'MAIN'),
                        preDough: recipes.value.filter((r) => r.type === 'PRE_DOUGH'),
                        extra: recipes.value.filter((r) => r.type === 'EXTRA'),
                    }));

                    const filteredFamilies = computed(() => {
                        return recipes.value.filter((r) => r.type === activeCategory.value);
                    });

                    function sortIngredients(ingredients, recipeType, recipeCategory) {
                        const isBreadLogic = (recipeType === 'PRE_DOUGH') || (recipeType === 'MAIN' && recipeCategory === 'BREAD');
                        const getRatio = (ing) => ing.ratio ?? -Infinity;

                        return [...ingredients].sort((a, b) => {
                            if (isBreadLogic) {
                                if (a.isFlour && !b.isFlour) return -1;
                                if (!a.isFlour && b.isFlour) return 1;
                                return getRatio(b) - getRatio(a);
                            } else {
                                return getRatio(b) - getRatio(a);
                            }
                        });
                    }

                    const sortedMainDoughIngredients = computed(() => {
                        if (!mainDough.value) return [];
                        return sortIngredients(
                            mainDough.value.ingredients,
                            currentFamily.value.type,
                            currentFamily.value.category
                        );
                    });

                    const sortedOtherIngredients = computed(() => {
                        if (!currentVersion.value || currentFamily.value.type === 'MAIN') return [];
                        return sortIngredients(
                            currentVersion.value.ingredients,
                            currentFamily.value.type,
                            currentFamily.value.category
                        );
                    });

                    const productsWithSortedMixIns = computed(() => {
                        if (!currentVersion.value || !currentVersion.value.products) return [];
                        return currentVersion.value.products.map(product => ({
                            ...product,
                            sortedMixIns: sortIngredients(product.mixIns, 'EXTRA', 'OTHER'),
                            sortedFillings: [...product.fillings].sort((a,b) => (b.weightInGrams ?? -Infinity) - (a.weightInGrams ?? -Infinity)),
                            sortedToppings: [...product.toppings].sort((a,b) => (b.weightInGrams ?? -Infinity) - (a.weightInGrams ?? -Infinity)),
                        }));
                    });

                    const recipeNamePlaceholder = computed(() =>
                        !currentFamily.value
                            ? ''
                            : { MAIN: '例如：法式长棍', PRE_DOUGH: '例如：波兰种', EXTRA: '例如：奶酥馅' }[
                                  currentFamily.value.type
                              ] || '配方名称',
                    );
                    const recipeTypeDisplay = (type) =>
                        ({ MAIN: '产品配方', PRE_DOUGH: '面种', EXTRA: '馅料/其他' })[type];

                    const availablePreDoughs = computed(() => recipes.value.filter((r) => r.type === 'PRE_DOUGH'));

                    const availablePreDoughsForReferencing = computed(() => {
                        if (
                            !currentFamily.value ||
                            currentFamily.value.type !== 'MAIN' ||
                            !currentVersion.value
                        )
                            return [];
                        const existingDoughNames = new Set(
                            currentVersion.value.doughs.filter((d) => d.type === 'PRE_DOUGH').map((d) => d.name),
                        );
                        return availablePreDoughs.value.filter((d) => !existingDoughNames.has(d.name));
                    });

                    watch(
                        () => currentVersion.value?.products,
                        () => {
                            nextTick(() => {
                                updateProductTabScrollButtons();
                            });
                        },
                        { deep: true },
                    );

                    watch([currentFamily, currentVersionIndex], () => {
                        if (currentFamily.value) {
                            nextTick(() => {
                                updateVersionTabScrollButtons();
                                if (currentFamily.value.type === 'MAIN') {
                                    activeProductTab.value = 0;
                                    updateProductTabScrollButtons();
                                }
                            });
                        }
                    });

                    const updateVersionTabScrollButtons = () => {
                        const el = versionTabsRef.value;
                        if (!el) {
                            tabScrollState.value.version = { showLeft: false, showRight: false };
                            return;
                        }
                        const hasOverflow = el.scrollWidth > el.clientWidth;
                        tabScrollState.value.version.showLeft = hasOverflow && el.scrollLeft > 0;
                        tabScrollState.value.version.showRight =
                            hasOverflow && el.scrollLeft < el.scrollWidth - el.clientWidth - 1;
                    };
                    const scrollVersionTabs = (amount) => {
                        versionTabsRef.value?.scrollBy({ left: amount, behavior: 'smooth' });
                    };

                    const updateProductTabScrollButtons = () => {
                        const el = productTabsRef.value;
                        if (!el) {
                            tabScrollState.value.product = { showLeft: false, showRight: false };
                            return;
                        }
                        const hasOverflow = el.scrollWidth > el.clientWidth;
                        tabScrollState.value.product.showLeft = hasOverflow && el.scrollLeft > 0;
                        tabScrollState.value.product.showRight =
                            hasOverflow && el.scrollLeft < el.scrollWidth - el.clientWidth - 1;
                    };
                    const scrollProductTabs = (amount) => {
                        productTabsRef.value?.scrollBy({ left: amount, behavior: 'smooth' });
                    };

                    function getNewVersion(type, category = 'BREAD') {
                        const commonIngredient = {
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            isFlour: false, 
                            waterContent: 0,
                        };

                        if (type === 'MAIN') {
                            return {
                                id: nextVersionId++,
                                notes: `V${nextVersionId}`, 
                                targetTemp: null,
                                doughs: [
                                    {
                                        id: nextIngredientId++,
                                        name: '主面团',
                                        type: 'MAIN_DOUGH',
                                        lossRatio: 1,
                                        divisionLoss: 2,
                                        ingredients: [JSON.parse(JSON.stringify(commonIngredient))],
                                        procedure: [''],
                                    },
                                ],
                                products: [
                                    {
                                        id: nextRecipeId++,
                                        name: '产品1',
                                        baseDoughWeight: 100,
                                        mixIns: [],
                                        fillings: [],
                                        toppings: [],
                                        procedure: [''],
                                    },
                                ],
                            };
                        }
                        return {
                            id: nextVersionId++,
                            notes: `V${nextVersionId}`, 
                            lossRatio: null,
                            ingredients: [JSON.parse(JSON.stringify(commonIngredient))],
                            procedure: [''],
                        };
                    }

                    function getNewFamily(type) {
                        const id = nextRecipeId++;
                        const category = type === 'MAIN' ? 'BREAD' : 'OTHER';
                        const firstVersion = getNewVersion(type, category);
                        firstVersion.notes = 'V1 - 初始版本'; 

                        return {
                            id,
                            name: '',
                            type: type,
                            category,
                            versions: [firstVersion],
                        };
                    }

                    const addFamily = () => {
                        const newFamily = getNewFamily(activeCategory.value);
                        recipes.value.push(newFamily);
                        selectFamily(newFamily.id); 
                    };

                    const selectFamily = (id) => {
                        suggestionState.value.visible = false;
                        currentFamilyId.value = id;
                        currentVersionIndex.value = 0; 
                    };

                    const deleteFamily = (id) => {
                        const index = recipes.value.findIndex((r) => r.id === id);
                        if (index === -1) return;
                        if (!confirm(`确定要删除 "${recipes.value[index].name || '未命名配方'}" 吗？`)) return;
                        if (currentFamilyId.value === id) {
                            currentFamilyId.value = null;
                            currentVersionIndex.value = 0;
                        }

                        savedRecipeSnapshots.value.delete(id); 
                        recipes.value.splice(index, 1);
                    };

                    const addVersion = () => {
                        if (!currentFamily.value) return;
                        const newVersion = JSON.parse(JSON.stringify(currentVersion.value));
                        newVersion.id = nextVersionId++;
                        newVersion.notes = `${currentVersion.value.notes} (副本)`;
                        currentFamily.value.versions.push(newVersion);
                        nextTick(() => {
                            currentVersionIndex.value = currentFamily.value.versions.length - 1;
                        });
                    };

                    const deleteVersion = (index) => {
                        if (!currentFamily.value || currentFamily.value.versions.length <= 1) {
                            alert('必须至少保留一个版本。');
                            return;
                        }
                        const versionNotes = currentFamily.value.versions[index].notes || `版本 ${index + 1}`;
                        if (!confirm(`确定要删除版本 "${versionNotes}" 吗？`)) return;

                        currentFamily.value.versions.splice(index, 1);
                        if (currentVersionIndex.value >= currentFamily.value.versions.length) {
                            currentVersionIndex.value = currentFamily.value.versions.length - 1;
                        }
                    };

                    const openAddPreDoughModal = () => {
                        isAddPreDoughModalVisible.value = true;
                    };
                    const addPreDoughReference = (dough) => {
                        const latestVersion = dough.versions[dough.versions.length - 1];
                        currentVersion.value.doughs.push({
                            ...JSON.parse(JSON.stringify(latestVersion)),
                            id: nextRecipeId++,
                            name: dough.name, 
                            type: 'PRE_DOUGH',
                            flourRatioInMainDough: 20,
                        });
                        isAddPreDoughModalVisible.value = false;
                    };
                    const removePreDough = (index) => {
                        const preDoughs = currentVersion.value.doughs.filter((d) => d.type === 'PRE_DOUGH');
                        const doughToRemove = preDoughs[index];
                        const originalIndex = currentVersion.value.doughs.findIndex((d) => d === doughToRemove);
                        if (originalIndex > -1) {
                            currentVersion.value.doughs.splice(originalIndex, 1);
                        }
                    };

                    const handleIngredientInput = (ingredient, event) => {
                        const query = event.target.value;
                        suggestionState.value.ingRef = ingredient;
                        suggestionState.value.target = event.target;

                        if (!query) {
                            suggestionState.value.visible = false;
                            suggestionState.value.suggestions = [];
                            return;
                        }

                        const suggestions = [];
                        const lowerQuery = query.toLowerCase();

                        for (const [name, data] of globalIngredientLibrary.value) {
                            if (name.toLowerCase().includes(lowerQuery)) {
                                suggestions.push({
                                    type: 'EXISTING',
                                    key: 'EXIST_' + name,
                                    name: name,
                                    isFlour: data.isFlour,
                                    waterContent: data.waterContent,
                                    selfMade: false
                                });
                            }
                        }

                        for (const name of selfMadeRecipeNames.value) {
                             if (name.toLowerCase().includes(lowerQuery)) {
                                const existingIdx = suggestions.findIndex(s => s.name === name);
                                if(existingIdx > -1) {
                                    suggestions[existingIdx].selfMade = true;
                                } else {
                                    suggestions.push({
                                        type: 'EXISTING',
                                        key: 'SELF_' + name,
                                        name: name,
                                        isFlour: false,
                                        waterContent: 0,
                                        selfMade: true
                                    });
                                }
                             }
                        }

                        const exactMatch = suggestions.find(s => s.name === query);
                        if (!exactMatch) {
                             suggestions.push({
                                 type: 'NEW_NORMAL',
                                 key: 'NEW_N_' + query,
                                 name: query
                             });
                             suggestions.push({
                                 type: 'NEW_FLOUR',
                                 key: 'NEW_F_' + query,
                                 name: query
                             });
                        }

                        suggestionState.value.suggestions = suggestions;
                        suggestionState.value.visible = suggestions.length > 0;
                    };

                    const handleIngredientBlur = (ingredient) => {
                        setTimeout(() => {
                            // 【修改点】在这里加一个判断：
                            // 只有当 "当前记录的焦点原料(ingRef)" 仍然是 "触发Blur的这个原料(ingredient)" 时，才执行关闭。
                            // 如果你已经点到了下一个输入框，Focus事件早就把 ingRef 更新成新的原料了，
                            // 此时 ingRef !== ingredient，这里的关闭逻辑就会被跳过，提示框就不会闪退啦。
                            
                            if (suggestionState.value.ingRef === ingredient) {
                                suggestionState.value.visible = false;

                                // 下面是原有的检查逻辑，保持在 if 里面即可
                                if (ingredient.name) {
                                    if (globalIngredientLibrary.value.has(ingredient.name)) {
                                        const libData = globalIngredientLibrary.value.get(ingredient.name);
                                        ingredient.isFlour = libData.isFlour;
                                    }
                                }
                                suggestionState.value.ingRef = null;
                            }
                        }, 200);
                    };

                    const selectSuggestion = (suggestion) => {
                        if (suggestionState.value.ingRef) {
                            const targetIng = suggestionState.value.ingRef;
                            targetIng.name = suggestion.name;

                            if (suggestion.type === 'EXISTING') {
                                targetIng.isFlour = suggestion.isFlour;
                                targetIng.waterContent = suggestion.waterContent;
                            } else if (suggestion.type === 'NEW_NORMAL') {
                                targetIng.isFlour = false;
                                targetIng.waterContent = 0;
                                globalIngredientLibrary.value.set(suggestion.name, {
                                    name: suggestion.name, isFlour: false, waterContent: 0
                                });
                            } else if (suggestion.type === 'NEW_FLOUR') {
                                targetIng.isFlour = true;
                                targetIng.waterContent = 0; 
                                globalIngredientLibrary.value.set(suggestion.name, {
                                    name: suggestion.name, isFlour: true, waterContent: 0
                                });
                            }
                        }
                        suggestionState.value.visible = false;
                        suggestionState.value.suggestions = [];
                        suggestionState.value.target = null;
                        suggestionState.value.ingRef = null; 
                    };

                    const addMainDoughIngredient = () =>
                        mainDough.value.ingredients.push({
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            isFlour: false,
                            waterContent: 0,
                        });
                    const removeMainDoughIngredient = (id) => {
                        const index = mainDough.value.ingredients.findIndex(i => i.id === id);
                        if (index > -1) mainDough.value.ingredients.splice(index, 1);
                    };
                    const addMainDoughProcedureStep = () => mainDough.value.procedure.push('');
                    const removeMainDoughProcedureStep = (index) => mainDough.value.procedure.splice(index, 1);

                    const addOtherIngredient = () =>
                        currentVersion.value.ingredients.push({
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            isFlour: false,
                            waterContent: 0,
                        });
                    const removeOtherIngredient = (id) => {
                        const index = currentVersion.value.ingredients.findIndex(i => i.id === id);
                        if (index > -1) currentVersion.value.ingredients.splice(index, 1);
                    };
                    const addOtherProcedureStep = () => currentVersion.value.procedure.push('');
                    const removeOtherProcedureStep = (index) => currentVersion.value.procedure.splice(index, 1);

                    const addProduct = () => {
                        currentVersion.value.products.push({
                            id: nextRecipeId++,
                            name: `产品${currentVersion.value.products.length + 1}`,
                            baseDoughWeight: 100,
                            mixIns: [],
                            fillings: [],
                            toppings: [],
                            procedure: [''],
                        });
                        nextTick(() => {
                            activeProductTab.value = currentVersion.value.products.length - 1;
                        });
                    };

                    const deleteProduct = (index) => {
                        const productName = currentVersion.value.products[index].name || `产品${index + 1}`;
                        if (!confirm(`确定要删除产品 "${productName}" 吗？`)) return;

                        currentVersion.value.products.splice(index, 1);

                        if (activeProductTab.value >= currentVersion.value.products.length) {
                            activeProductTab.value = Math.max(0, currentVersion.value.products.length - 1);
                        }
                    };

                    const addSubIngredient = (prodIndex, type) =>
                        currentVersion.value.products[prodIndex][type].push({
                            id: nextIngredientId++,
                            name: '',
                            ratio: null,
                            weightInGrams: null,
                            isFlour: false,
                            waterContent: 0,
                        });
                    const removeSubIngredient = (productId, type, ingredientId) => {
                        const product = currentVersion.value.products.find(p => p.id === productId);
                        if (product) {
                            const index = product[type].findIndex(i => i.id === ingredientId);
                            if (index > -1) {
                                product[type].splice(index, 1);
                            }
                        }
                    };
                    const addProductProcedureStep = (prodIndex) =>
                        currentVersion.value.products[prodIndex].procedure.push('');
                    const removeProductProcedureStep = (prodIndex, stepIndex) =>
                        currentVersion.value.products[prodIndex].procedure.splice(stepIndex, 1);

                    const toDecimal = (percentage) =>
                        percentage === null || percentage === undefined
                            ? 0
                            : parseFloat((parseFloat(percentage) / 100).toPrecision(12));
                    const toPercentage = (decimal) =>
                        decimal === null || decimal === undefined ? null : parseFloat((decimal * 100).toPrecision(12));

                    const updateSnapshot = () => {
                        savedRecipeSnapshots.value.clear();
                        for (const family of recipes.value) {
                            savedRecipeSnapshots.value.set(family.id, JSON.stringify(family));
                        }
                    };

                    const loadRecipesFromJson = (jsonString) => {
                        try {
                            const importedData = JSON.parse(jsonString);
                            if (!Array.isArray(importedData)) throw new Error('JSON文件格式不正确，根节点应为数组。');

                            const preDoughMap = new Map();
                            importedData
                                .filter((r) => r.type !== 'MAIN')
                                .forEach((family) => {
                                    if (family.versions && family.versions.length > 0) {
                                        preDoughMap.set(family.name, family.versions[family.versions.length - 1]);
                                    }
                                });

                            const normalizedFamilies = importedData.map((family) => {
                                const newFamily = {
                                    id: nextRecipeId++,
                                    name: family.name,
                                    type: family.type,
                                    category: family.category || (family.type === 'MAIN' ? 'BREAD' : 'OTHER'),
                                    versions: [],
                                };

                                if (!family.versions || family.versions.length === 0) {
                                    console.warn(
                                        `配方 "${family.name}" 是旧格式，将自动转换为 V1 版本。`,
                                    );
                                    const v1 = normalizeVersion(
                                        family, 
                                        family.type,
                                        family.category,
                                        preDoughMap,
                                    );
                                    v1.notes = 'V1 - (从旧格式导入)';
                                    newFamily.versions = [v1];
                                } else {
                                    newFamily.versions = family.versions.map((version) => {
                                        return normalizeVersion(
                                            version,
                                            family.type,
                                            family.category,
                                            preDoughMap,
                                        );
                                    });
                                }
                                return newFamily;
                            });

                            recipes.value = normalizedFamilies;
                            
                            savedRecipeSnapshots.value.clear();
                            for (const family of normalizedFamilies) {
                                savedRecipeSnapshots.value.set(family.id, JSON.stringify(family));
                            }

                            if (recipes.value.length > 0) {
                                nextTick(() => {
                                    activeCategory.value = 'MAIN';
                                    const firstMainRecipe = recipes.value.find(r => r.type === 'MAIN');

                                    if (firstMainRecipe) {
                                        selectFamily(firstMainRecipe.id);
                                    } else {
                                        selectFamily(recipes.value[0].id);
                                        activeCategory.value = recipes.value[0].type;
                                    }
                                });
                            } else {
                                currentFamilyId.value = null;
                            }
                            alert(`成功加载 ${normalizedFamilies.length} 个配方族！`);
                        } catch (err) {
                            console.error('Load Error:', err);
                            alert(`加载失败：${err.message}`);
                        }
                    };

                    const triggerImport = () => fileInput.value.click();
                    const handleFileImport = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            fileHandle.value = null;
                            loadRecipesFromJson(e.target.result);
                            event.target.value = '';
                        };
                        reader.readAsText(file);
                    };

                    function normalizeVersion(versionData, familyType, familyCategory, preDoughMap) {
                        const baseVersion = {
                            id: nextVersionId++,
                            notes: versionData.notes || 'V?',
                            targetTemp: null,
                            lossRatio: null,
                            doughs: [],
                            products: [],
                            ingredients: [],
                            procedure: [],
                        };

                        const processImportedIngredient = (ing) => {
                            if (!globalIngredientLibrary.value.has(ing.name)) {
                                globalIngredientLibrary.value.set(ing.name, {
                                    name: ing.name,
                                    isFlour: !!ing.isFlour,
                                    waterContent: ing.waterContent || 0
                                });
                            }
                            
                            const libData = globalIngredientLibrary.value.get(ing.name);

                            return {
                                id: nextIngredientId++,
                                name: ing.name,
                                ratio: toPercentage(ing.ratio),
                                isFlour: libData.isFlour, 
                                waterContent: libData.waterContent,
                            };
                        };

                        if (familyType === 'MAIN') {
                            const preDoughs = [];
                            const mainDoughIngredients = [];

                            (versionData.ingredients || []).forEach((ing) => {
                                if (preDoughMap.has(ing.name)) {
                                    const preDoughDef = preDoughMap.get(ing.name);
                                    if (preDoughDef) {
                                        const processedPreDoughIngredients = (preDoughDef.ingredients || []).map(
                                            processImportedIngredient,
                                        );
                                        preDoughs.push({
                                            id: nextRecipeId++,
                                            name: ing.name,
                                            type: 'PRE_DOUGH',
                                            flourRatioInMainDough: toPercentage(ing.flourRatio),
                                            ingredients: processedPreDoughIngredients,
                                            procedure: preDoughDef.procedure || [],
                                        });
                                    }
                                } else {
                                    mainDoughIngredients.push(processImportedIngredient(ing));
                                }
                            });

                            const mainDoughData = {
                                id: nextIngredientId++,
                                name: '主面团',
                                type: 'MAIN_DOUGH',
                                lossRatio: toPercentage(versionData.lossRatio),
                                divisionLoss: versionData.divisionLoss === undefined ? 2 : versionData.divisionLoss,
                                procedure:
                                    versionData.procedure && versionData.procedure.length > 0
                                        ? versionData.procedure
                                        : [''],
                                ingredients:
                                    mainDoughIngredients.length > 0
                                        ? mainDoughIngredients
                                        : [
                                              {
                                                  id: nextIngredientId++,
                                                  name: '',
                                                  ratio: null,
                                                  isFlour: false,
                                                  waterContent: 0,
                                              },
                                          ],
                            };

                            baseVersion.targetTemp = versionData.targetTemp || null;
                            baseVersion.doughs = [mainDoughData, ...preDoughs];
                            baseVersion.products =
                                versionData.products && versionData.products.length > 0
                                    ? versionData.products.map((p) => ({
                                          id: nextRecipeId++,
                                          name: p.name,
                                          baseDoughWeight: p.weight,
                                          mixIns: (p.mixIn || []).map((i) => ({
                                              id: nextIngredientId++,
                                              name: i.name,
                                              ratio: toPercentage(i.ratio),
                                              weightInGrams: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          })),
                                          fillings: (p.fillings || []).map((i) => ({
                                              id: nextIngredientId++,
                                              name: i.name,
                                              weightInGrams: i.weightInGrams,
                                              ratio: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          })),
                                          toppings: (p.toppings || []).map((i) => ({
                                              id: nextIngredientId++,
                                              name: i.name,
                                              weightInGrams: i.weightInGrams,
                                              ratio: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          })),
                                          procedure: p.procedure && p.procedure.length > 0 ? p.procedure : [''],
                                      }))
                                    : [
                                          {
                                              id: nextRecipeId++,
                                              name: '产品1',
                                              baseDoughWeight: 100,
                                              mixIns: [],
                                              fillings: [],
                                              toppings: [],
                                              procedure: [''],
                                          },
                                      ];
                        } else {
                            baseVersion.lossRatio = toPercentage(versionData.lossRatio) || null;
                            baseVersion.ingredients =
                                versionData.ingredients && versionData.ingredients.length > 0
                                    ? versionData.ingredients.map(processImportedIngredient)
                                    : [
                                          {
                                              id: nextIngredientId++,
                                              name: '',
                                              ratio: null,
                                              isFlour: false,
                                              waterContent: 0,
                                          },
                                      ];
                            baseVersion.procedure =
                                versionData.procedure && versionData.procedure.length > 0
                                    ? versionData.procedure
                                    : [''];
                        }
                        return baseVersion;
                    }

                    function exportVersion(version, familyType, familyCategory) {
                        const formatIngredient = (ing) => {
                            const result = {
                                name: ing.name,
                                ratio: toDecimal(ing.ratio),
                            };
                            if (ing.isFlour) {
                                result.isFlour = true;
                            }
                            if (ing.waterContent && ing.waterContent > 0) {
                                result.waterContent = ing.waterContent;
                            }
                            return result;
                        };

                        if (familyType === 'MAIN') {
                            const md = version.doughs.find((d) => d.type === 'MAIN_DOUGH');
                            const sortedMainIngredients = sortIngredients(md.ingredients, familyType, familyCategory);

                            const finalIngredients = [
                                ...version.doughs
                                    .filter((d) => d.type === 'PRE_DOUGH')
                                    .map((pd) => ({
                                        name: pd.name,
                                        flourRatio: toDecimal(pd.flourRatioInMainDough),
                                    })),
                                ...sortedMainIngredients
                                    .filter((ing) => ing.name.trim() && ing.ratio !== null)
                                    .map(formatIngredient),
                            ];
                            return {
                                notes: version.notes,
                                targetTemp: version.targetTemp,
                                lossRatio: toDecimal(md.lossRatio),
                                divisionLoss: md.divisionLoss,
                                procedure: md.procedure.filter((p) => p.trim()),
                                ingredients: finalIngredients,
                                products: version.products.map((p) => {
                                    const sortedMixIns = sortIngredients(p.mixIns, 'EXTRA', 'OTHER'); 
                                    const sortedFillings = [...p.fillings].sort((a,b) => (b.weightInGrams ?? -Infinity) - (a.weightInGrams ?? -Infinity));
                                    const sortedToppings = [...p.toppings].sort((a,b) => (b.weightInGrams ?? -Infinity) - (a.weightInGrams ?? -Infinity));
                                    
                                    return {
                                        name: p.name,
                                        weight: p.baseDoughWeight,
                                        procedure: p.procedure.filter((step) => step.trim()),
                                        mixIn: sortedMixIns 
                                            .filter((i) => i.name.trim() && i.ratio !== null)
                                            .map((i) => ({ name: i.name, ratio: toDecimal(i.ratio) })),
                                        fillings: sortedFillings 
                                            .filter((i) => i.name.trim() && i.weightInGrams !== null)
                                            .map((i) => ({ name: i.name, weightInGrams: i.weightInGrams })),
                                        toppings: sortedToppings 
                                            .filter((i) => i.name.trim() && i.weightInGrams !== null)
                                            .map((i) => ({ name: i.name, weightInGrams: i.weightInGrams })),
                                    }
                                }),
                            };
                        } else {
                            const sortedIngredients = sortIngredients(version.ingredients, familyType, familyCategory);
                            return {
                                notes: version.notes,
                                lossRatio: toDecimal(version.lossRatio),
                                ingredients: sortedIngredients
                                    .filter((ing) => ing.name.trim() && ing.ratio !== null)
                                    .map(formatIngredient),
                                procedure: version.procedure.filter((p) => p.trim()),
                                products: [],
                            };
                        }
                    }

                    const getRecipesAsJsonString = () => {
                        if (recipes.value.length === 0) {
                            alert('请先添加至少一个配方');
                            return null;
                        }

                        for (const family of recipes.value) {
                            const isCheckable = family.type === 'PRE_DOUGH' || (family.type === 'MAIN' && family.category === 'BREAD');

                            if (isCheckable) {
                                for (const version of family.versions) {
                                    
                                    let totalFlourRatio = 0; 
                                    let context = ''; 

                                    if (family.type === 'MAIN') {
                                        context = `配方 "${family.name || '未命名'}" (版本: ${version.notes || 'V?'})`;
                                        
                                        const mainDough = version.doughs.find((d) => d.type === 'MAIN_DOUGH');
                                        if (mainDough) {
                                            totalFlourRatio += mainDough.ingredients.reduce((sum, ing) => {
                                                return ing.isFlour ? sum + (ing.ratio || 0) : sum;
                                            }, 0);
                                        }

                                        const preDoughs = version.doughs.filter((d) => d.type === 'PRE_DOUGH');
                                        totalFlourRatio += preDoughs.reduce((sum, dough) => {
                                            return sum + (dough.flourRatioInMainDough || 0);
                                        }, 0);

                                    } else { 
                                        context = `面种 "${family.name || '未命名'}" (版本: ${version.notes || 'V?'})`;
                                        if (version.ingredients.length > 0) {
                                            totalFlourRatio = version.ingredients.reduce((sum, ing) => {
                                                return ing.isFlour ? sum + (ing.ratio || 0) : sum;
                                            }, 0);
                                        }
                                    }

                                    if (totalFlourRatio > 0 && Math.abs(totalFlourRatio - 100) > 1e-9) {
                                        alert(
                                            `保存失败：\n\n${context}\n中所有面粉类原料（主面团面粉 + 面种引用面粉）的比例总和不等于 100%。\n\n当前总和: ${totalFlourRatio.toFixed(2)}%\n\n请检查并修正后再保存。`,
                                        );
                                        return null; 
                                    }
                                }
                            }
                        }

                        try {
                            const typeOrder = { 'PRE_DOUGH': 1, 'EXTRA': 2, 'MAIN': 3 };
                            const sortedFamilies = [...recipes.value].sort((a, b) => {
                                const orderA = typeOrder[a.type] || 99;
                                const orderB = typeOrder[b.type] || 99;
                                return orderA - orderB;
                            });

                            const processedFamilies = sortedFamilies.map((family) => { 
                                if (!family.name || !family.name.trim())
                                    throw new Error(`列表中有未命名的配方族，请检查后再导出。`);

                                return {
                                    name: family.name,
                                    type: family.type,
                                    category: family.category,
                                    versions: family.versions.map((v) => exportVersion(v, family.type, family.category)),
                                };
                            });
                            return JSON.stringify(processedFamilies, null, 4);
                        } catch (err) {
                            alert(`处理数据失败: ${err.message}`);
                            return null;
                        }
                    };

                    const exportAllJson = () => {
                        const jsonString = getRecipesAsJsonString();
                        if (!jsonString) return;

                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `recipes_batch_export.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    };

                    const openFile = async () => {
                        try {
                            const [handle] = await window.showOpenFilePicker({
                                types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
                            });
                            const file = await handle.getFile();
                            const content = await file.text();
                            fileHandle.value = handle;
                            loadRecipesFromJson(content);
                        } catch (err) {
                            console.error('Failed to open file:', err);
                            if (err.name !== 'AbortError') {
                                alert(`打开文件失败: ${err.message}`);
                            }
                        }
                    };

                    const saveFile = async () => {
                        if (!fileHandle.value) {
                            alert('没有可保存的文件句柄。请先“打开文件”。');
                            return;
                        }
                        try {
                            const jsonString = getRecipesAsJsonString();
                            if (!jsonString) return;

                            const writable = await fileHandle.value.createWritable();
                            await writable.write(jsonString);
                            await writable.close();
                            alert('文件保存成功！');
                            updateSnapshot();
                        } catch (err) {
                            console.error('Failed to save file:', err);
                            alert(`保存文件失败: ${err.message}`);
                        }
                    };

                    const handleBeforeUnload = (event) => {
                        if (isDirty.value) {
                            event.preventDefault();
                            event.returnValue = '';
                        }
                    };

                    onMounted(() => {
                        window.addEventListener('beforeunload', handleBeforeUnload);
                    });
                    onUnmounted(() => {
                        window.removeEventListener('beforeunload', handleBeforeUnload);
                    });

                    return {
                        recipes,
                        currentFamilyId,
                        currentVersionIndex,
                        activeProductTab,
                        currentFamily,
                        currentVersion,
                        mainDough,
                        fileInput,
                        recipeNamePlaceholder,
                        recipeTypeDisplay,
                        isSelfMade,
                        recipeCategories,
                        filteredFamilies,
                        isAddPreDoughModalVisible,
                        categoryDisplay,
                        recipeContentTitle,
                        mainRecipeCategories,
                        availablePreDoughs,
                        availablePreDoughsForReferencing,
                        activeCategory,
                        mainContentRef,
                        productTabsRef,
                        versionTabsRef,
                        tabScrollState,
                        suggestionState,
                        suggestionBoxStyle,
                        processedPreDoughs,
                        isFSApiSupported,
                        fileHandle,
                        isFamilyDirty,
                        addFamily,
                        selectFamily,
                        deleteFamily,
                        addVersion,
                        deleteVersion,
                        triggerImport,
                        handleFileImport,
                        openAddPreDoughModal,
                        addPreDoughReference,
                        removePreDough,
                        handleIngredientInput,
                        handleIngredientBlur,
                        selectSuggestion,
                        scrollVersionTabs,
                        updateVersionTabScrollButtons,
                        scrollProductTabs,
                        updateProductTabScrollButtons,
                        addMainDoughIngredient,
                        removeMainDoughIngredient,
                        addMainDoughProcedureStep,
                        removeMainDoughProcedureStep,
                        addOtherIngredient,
                        removeOtherIngredient,
                        addOtherProcedureStep,
                        removeOtherProcedureStep,
                        addProduct,
                        deleteProduct,
                        addSubIngredient,
                        removeSubIngredient,
                        addProductProcedureStep,
                        removeProductProcedureStep,
                        exportAllJson,
                        openFile,
                        saveFile,
                        updatePreDoughRatio, 
                        sortedMainDoughIngredients,
                        sortedOtherIngredients,
                        productsWithSortedMixIns,
                        showFlourCheckbox, 
                        getWrapperClass, 
                        totalWaterRatio // 新增的计算属性
                    };
                },
            }).mount('#app');
        </script>
    </body>
</html>